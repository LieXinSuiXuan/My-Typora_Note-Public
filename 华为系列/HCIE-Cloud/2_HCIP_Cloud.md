fusioncomputer6.0之前的版本使用的xen的架构 
现在6.0之后的使用的是kvm的架构  

xen的架构： 搭建完成xen的架构后 会自动生成dom0的主机 
所有的io请求全部都发送到dom0上 如果虚拟机的数量越多 dom0的资源分配的越多 dom0根据顺序都要依次去进行需求 
缺点：dom0会成为性能瓶颈 因为每一次的io请求都要经过dom0
只能支持半虚

kvm的架构：实现cpu和内存的虚拟化 
现在的kvm是kvm.ko和qemu的合并的一个产品
qemu是一套独立的虚拟化方案  安装完成qemu后能在电脑里创建独立的虚拟机  
qemu可以模拟io设备(磁盘网卡等)

完整的kvm解决方案： 
KVM=libvirt+kvm 
安装"Virtualization Host"包组
安装virtual-manager  
在virtual-Manager中安装虚拟机 
给虚拟机装系统  
装完系统后配置网络  
配置网络的方法是红帽6 红帽7的网络配置的方法 
原理在RHCE中 网络配置为桥接 

FusionSphere虚拟化套件
FusionAccess 企业桌面云 
ebackup 数据拷贝备份 有多少数据没有备份就有多少数据丢失 
FusionManager 虚拟机业务容灾 
UltraVR 升级换代为了eraplication
eraplication 业务级容灾 在短时间内拉活业务 
FusionStorage 将很多的老旧服务器中的存储做成一个分布式存储 

FusionComputer高级特性： 
VRM为FC架构提供了一个web界面来供管理 
FC可以带来资源的共享  
一台服务器可以跑多个虚拟机 一台虚拟机中跑少量的业务 用多台虚拟机来进行实现 来达到资源的的利用率最大化 一般资源的利用率达到百分之六十到七十左右 不会让资源利用率太高 过高的资源利用率会导致服务器卡顿 
故障切换：服务器挂掉了 HA高可用节点故障 虚拟机热迁移到其他的节点 不断业务 
HA会停业务 



主机故障处理策略： 
原主机恢复虚拟机 用于故障不大的情况 等待原主机修好之后再开机
HA恢复虚拟机 在另外的主机上开机 进行高可用 
主机数据恢复策略： 
不处理
HA策略 
延迟策略 选择延迟时间 延迟到相应时间之后再采用策略
HA定义： 
是一种高可用的特性，当物理机或者虚拟机故障的时候，会根据集群HA策略将宕掉的虚拟机在正常工作的主机上开启，减少业务中断的时间 
需要人为打开集群的配置 

故障切换主机 相当于备胎 专门预留出来一个CNA来跑HA虚拟机

HA会丢数据 丢掉的是内存中的数据 在发生灾难的时候内存中的数据没有刷到磁盘里面 

CNA的负载均衡会做到虚拟机的热迁移 

主机的更新换代也会用到虚拟机的热迁移

虚拟机的热迁移： 
旧的虚拟机中的数据会用迭代迁移的技术实时向新的虚拟机中写 当两个虚拟机的数据差异足够小的时候会用卡顿的方法来关机旧的虚拟机 也就是io悬挂  开启新的虚拟机 并且更改映射关系 从而访问新的虚拟机来进行业务 同时新的虚拟机也会访问到下层的业务存储 

使用本地磁盘的虚拟机不能做热迁移 只有使用共享存储的虚拟机才能使用热迁移 

原主机恢复虚拟机： 在主机故障的时候必须要等原来的物理设备好了之后才可以重新启动虚拟机

数据存储故障不做HA配置 

虚拟机HA流程： 
1.当VM故障或者物理节点故障的时候，VRM查询VM状态发现VM故障 
2.VRM节点判断VM有HA特性，根据保存的VM信息选择可用的CNA主机启动VM
3.CNA节点收到HA请求，根据VM规格，卷信息创建新的VM，启动的过程中将VM之前的卷重新挂载，包括用户卷

虚拟机HA约束条件： 
VM层面：安装tools且正常运行，没有外设绑定
FC层面： 必须为共享存储，目标主机和源主机在同一集群且网络互通，集群开启HA功能，目标有足够的资源开启VM

非虚拟化数据存储不能实现热迁移 只能停掉业务后再迁移 

虚拟机热迁移的约束条件： 
1.虚拟机的要求： 虚拟机状态为运行中 
虚拟机未绑定图形处理器 USB设备等外设 
2.计算资源的要求： 
目标主机不能是维护状态 
目标主机要有足够的CPU和内存资源 
当跨集群迁移的时候，源主机所属集群和目标主机所属集群的内存复用开关需要相同 
迁移的过程中，不能下电或者重启源目标主机 
如果源主机和目标主机的CPU类型不一致的话 需要开启集群的IMC模式 
3.存储要求： 
虚拟机磁盘所属的数据存储必须是共享存储 
4.网络要求： 
源目标主机网络必须相同的DVS

存储热迁移应用场景：
1.将数据存储的所有卷都迁移之后 可以对数据存储进行减容
2.可以调整数据存储之间的负荷 做负载均衡
3.可以调整虚拟机磁盘的性能

两个8核的可以超线程的cpu可以虚拟出来32个VCPU
一个超线程数就等于一个VCPU

内存复用： 
内存共享： 相同的内存一起使用 只存储不同的数据 只具有只读的效果 
写时复制：当虚拟机需要对内存进行操作的时候 开辟另外一部分空间 并修改映射
写前拷贝： 把原本的数据拷贝一份新的到另外一部分内存空间 并且修改其他虚拟机的映射关系 在原本的数据上做修改然后增加相对应的映射关系 
内存交换分区： 内存中长时间没有被访问的数据为冷数据 冷数据都被刷在硬盘中 内存中的数据都被成为热数据 当再次需要使用的时候把硬盘中的数据刷到内存中、
内存气泡： 把虚拟机中的空闲内存进行回收 然后再给缺内存的虚拟机使用 

NUMA亲和性调度： VCPU和虚拟内存都来自同一个节点 来保证性能最高 

动态资源调度DRS： 依赖虚拟机热迁移 
做好迁移计划 来进行自动化虚拟机热迁移 
用于做负载均衡  
自动选择合适的物理机进行上电或者下电 
做虚拟机热迁移的时候避开业务高峰期 

DPM： 
电源管理 自动关机或者开机 保证资源利用最大化 

IMC： 打开IMC后高版本指令集向低版本的指令集同步 

规则组： 
聚集虚拟机：列出的虚拟机必须在统一主机上运行
在迁移聚集虚拟机中的任意一台虚拟机的时候 其他的几台也会跟着一起走 保证性能提升 

互斥虚拟机： 列出的虚拟机必须在不同的主机上运行
同一个集群做备份的时候做互斥虚拟机 
两台虚拟机不能迁移到同一台物理机上 

虚拟机到主机： 虚拟机组的成员是否能在特定主机组的成员上运行
虚拟机组和主机组做关联 特定的虚拟机使用特定的主机资源 

磁盘类型： 
精简： 按需分配 写性能很差 需要一点空间就格式化一点空间 
写A-->扫描A-->空间申请-->格式化-->A 
普通： 空间一次性到位 同时格式化操作 
普通延迟置零： 创建磁盘的时候此案空间一次到位 但是没有格式化操作 在首次写磁盘的时候全盘置零 首次写性能差 后续写盘的时候跟普通磁盘性能相当 

固态磁盘文件： 普通磁盘  

动态磁盘文件： 精简磁盘和普通延迟置零磁盘 

差分磁盘文件：  结构和动态磁盘一样 但是头文件中会记录父文件的路径  
差分卷不能独立存在 差分卷可以是父文件 
配合快照 非持久化磁盘 链接克隆等功能一起使用 保护源盘不被修改 

精简磁盘和空间回收： 
原先在写数据擦除之后的一部分空间原本还是属于自己 但是使用了空间回收工具之后 那一部分空间也可以进行分配 

快照： 
存储快照 
COW：写前拷贝

ROW：写时重定向 
针对文件系统打快照 

快照LUN： 有mata区域也有data区域
快照LUN中至拷贝元数据 不拷贝data

快照LUN中存的是元数据 当源数据LUN中的数据修改了之后 修改钱的数据会存在COW空间 快照LUN的映射关系变更在COW空间中 而源LUN中的数据映射关系不变 

在源数据和快照数据的映射中 如果有两条映射关系的话 那个数据就是保护数据 

ROW：完整复制一份数据 
快照文件系统指针不变 源文件系统的指针改变 写进的数据中 源文件的数据优先落盘 然后向源文件系统更改映射关系  提高了性能 
虚拟机快照一般使用ROW 快照内容为只读 

ROW原理： 
在独一文件系统使用ROW快照的时候 会完全拷贝一份文件系统 这是拷贝内容的数据为只读状态 在要修改的时候 新数据另外开辟一份空间 这时的数据会落在差分卷上 


block设备只能使用COW快照 

为磁盘打快照的时候 在打快照的时候 会生成一个差分卷 差分卷是一个逻辑概念 按需分配 
原卷锁定成为快照卷 快照中的数据被锁定 快照是只读的 和原来的数据有变动的地方存在差分卷中 
在第二次打快照的时候 原本的差分卷被锁定为快照卷2 生成差分卷2 第三次和后面打快照的时候一次按照这个规律
这是一次快照链的形成 拍摄快照和生成快照 


删除快照的过程： 
删除其中的一个分卷之后 会向前合并分卷 数据内容不会被改变 



快照恢复过程： 
将快照链的指针回滚到上一快照 只是改变指向  不是删除数据 只是改变快照链
快照部分是被保护对象  没有快照的部分就不是被保护对象




fusionaccess桌面云： 
在云上发放桌面 来进行使用 
FC上面百分之九十以上的都是linux 
FA上的基本上都是Windows操作系统 

在任意配置的笔记本上 来使用云上的桌面操作系统 用来降低前期成本 

桌面云的优势： 
数据安全 终端与数据隔离 防止泄密 高可靠性架构 
运维效率 桌面标准化 快速发放 集中运维 
灵活性 资源按需分配  移动办公 

VRM的ip是登录fusionComputer的ip  
ITA的ip是登录fusionAccess的ip

ITA：wi license db hdc 
AD： dns dhcp


华为桌面云软件部署方案
HDC： 华为桌面控制器
LIC:授权管理
ITA: it资源适配管理  提供FA的登录界面 
DB: 一种关系数据库
AUS:应用升级服务器
TCM : 瘦客户端管理vLB :
vAG:虚拟接入网关
vLB：虚拟负载均衡
SVN：华为安全网关与负载均衡产品
WI:用户门户接口  虚拟机登录入口
HDA: HDP代理
HDP Client : HDP客户端
APS: 应用服务器
TC: 瘦客户端
SC: 软客户端
license  许可证  一个license对应一个虚拟机

AD       管理目录 管理计算机打印机等设备  
DNS      域名解析 
DHCP       自动获取IP 

AD配置： 只有计算机名唯一 ip唯一的才能成为域控

dns 做域名解析

AD域中可以划分OU 来接管服务器
ad域中 相同属性的划分为一个OU







生产环境中： linux跑业务的时候需要时刻业务不丢









