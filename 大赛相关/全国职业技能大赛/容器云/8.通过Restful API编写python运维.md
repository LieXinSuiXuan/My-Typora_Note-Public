### 案例准备

沿用上一案例的开发环境。

#### 查询Token

（1）使用kube-system命名空间创建服务账号“admin1”：

```shell
[root@master ~]# kubectl create serviceaccount admin1 -n kube-system
```

（2） 创建RBAC，并进行集群角色绑定

```shell
[root@master ~]# kubectl create clusterrolebinding admin1 --clusterrole=cluster-admin --serviceaccount=kube-system:admin1
```

（3） 查询secrets与 Token

```shell
[root@master ~]# kubectl get secrets -n kube-system  
NAME                                             TYPE                                  DATA   AGE
admin1-token-gvmzk                               kubernetes.io/service-account-token   3      74s
[root@master ~]#  kubectl describe secrets -n kube-system admin1-token-gvmzk
Name:         admin1-token-gvmzk
Namespace:    kube-system
Labels:       <none>
Annotations:  kubernetes.io/service-account.name: admin1
              kubernetes.io/service-account.uid: 22b72691-8c94-472a-b306-b13ab0c15930

Type:  kubernetes.io/service-account-token

Data
====
namespace:  11 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImZEckplcC1GNlZvMTNWU1cxcXExSDU1SGZ0d3FhR3ZzODZDdy1udjhicm8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbjEtdG9rZW4tZ3ZtemsiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiYWRtaW4xIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMjJiNzI2OTEtOGM5NC00NzJhLWIzMDYtYjEzYWIwYzE1OTMwIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmFkbWluMSJ9.h-Z_Kf5ow26cK70164_in5fW_ifDf5xjsASeJ7wk0i3wjfr6mQT0ujnpfu303PdVNxxpQ_SeqfvK463Ev6To3PdTDgIwCa5NAHzb1b4nb6e-MX8GkBY3hiyJ6cb2d8N6zSBQOE9xpwE78RlPeAA72o5Nab-ilZwXArIcBw3PrFE3Rl5NprkwV1qaE0kHS0LfopYkz4FKW-4KzyH50BBHzAwMjof20kn_ulht8ex8qcBpkf2nWUCfrDJ8hg5dfjNhY-GYW5kGAxlDMpqjnySkwiA9lyb9ZnwoDgCHQ-bbkOdmK53OZbVZgNS1RfvcAoK88v8K0peupTFFGCQPiXBjUQ
ca.crt:     1099 bytes
```

### 案例实施

#### 1. Pod资源管理

（1） 代码实现

创建Pod使用本地yaml文件，nginx-pod.yaml文件内容如下：

```yaml
[root@master ~]# cat nginx-pod.yaml 
apiVersion: v1  
kind: Pod  
metadata:  
  name: pod-nginx  
spec:  
  containers:  
    - name: nginx  
      image: nginx:1.15.4  
      ports:  
      - containerPort: 8080  
        protocol: TCP 
```

创建api_pod_manager.py，进行Pod的增删查改操作：

```python
[root@master ~]# cat api_pod_manager.py 
# Copyright 2021~2022 The Cloud Computing support Teams of ChinaSkills.  
from ipaddress import ip_address  
import requests, json, time  
import logging  
import os, yaml  
# -----------logger-----------  
# get logger  
logger = logging.getLogger(__name__)  
# level  
logger.setLevel(logging.DEBUG)  
# format  
format = logging.Formatter('%(asctime)s %(message)s')  
# to console  
stream_handler = logging.StreamHandler()  
stream_handler.setFormatter(format)  
logger.addHandler(stream_handler)  
# -----------logger-----------  
# https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#pod-v1-core  
def get_api_server_token(api_server_token, node_url):  
   #for request header  
   bearer_token = "bearer " + api_server_token  
   return bearer_token  
class pod_manager(): 
   def __init__(self, node_url: str, bearer_token: str): 
       self.node_url = node_url  
       self.bearer_token = bearer_token  
   # 创建pod  
   def create_pod(self, yamlFile:str,namespace:str):  
       headers = {  
           "Authorization": self.bearer_token,  
           "Content-Type": "application/json"  
      }  
       # 读取yaml文件，并转化为JSON数据  
       with open(yamlFile, encoding="utf8") as f:  
           body = json.dumps(yaml.safe_load(f))  
       request_url = self.node_url + "/api/v1/namespaces/" + namespace +"/pods"  
       result = json.loads(requests.post(request_url, data=body, headers=headers, verify=False).text)  
       logger.debug(f"返回信息:{str(result)}")  
       return result  
   # 查询上面创建的pod  
   def get_pod(self, pod_name: str):  
       headers = {  
           "Authorization": self.bearer_token  
      }  
       request_url = self.node_url + "/api/v1/namespaces/kube-system/pods/" + pod_name  
       result = json.loads(requests.get(request_url, headers=headers, verify=False).text)  
       logger.debug(f"返回信息:{str(result)}")  
       return result  
   #更新Pod的镜像为nginx:1.16  
   def update_pod(self, yamlFile:str, pod_name:str,namespace:str):  
       headers = {  
           "Authorization": self.bearer_token,  
           "Content-Type": "application/strategic-merge-patch+json"  
      }  
       # 读取yaml文件，并转化为JSON数据  
       with open(yamlFile, encoding="utf8") as f:  
           body = json.dumps(yaml.safe_load(f))  
       request_url = self.node_url + "/api/v1/namespaces/" + namespace + "/pods" + pod_name  
       result = json.loads(requests.patch(request_url, data=json.dumps(body), headers=headers, verify=False).text)  
       logger.debug(f"返回信息:{str(result)}")  
       return result  
   #删除pod  
   def delete_pod(self,pod_name: str):  
       headers = {  
           "Authorization": self.bearer_token  
      }  
       request_url = self.node_url + "/api/v1/namespaces/kube-system/pods/" + pod_name  
       result = json.loads(requests.delete(request_url, headers=headers, verify=False).text)  
       logger.debug(f"返回信息:{str(result)}")  
       return result  
if __name__ == "__main__":  
   # 使用自建token  
   # 命令如下  
   # kubectl create serviceaccount admin1 -n kube-system  
   # kubectl create clusterrolebinding admin1 --clusterrole=cluster-admin --serviceaccount=kube-system:admin1  
   # 查询名称admin1 - token - lwf5v  
   # kubectl get secrets -n kube-system  
   # kubectl describe secrets -n kube-system admin1-token-lwf5v  
   # 将获取到的token值放到api_server_token中去  
   api_server_token = "eyJhbGciOiJSUzI1NiIsImtpZCI6IjNBN0lTYmJQWERIdVNlbGl5Rk5TVFpOLVozQTlTMU5WQUs3UERfSzRnVG8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbjEtdG9rZW4tdjhoNXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiYWRtaW4xIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNzViMzA4YjgtNDY1My00Y2RlLWI0YzEtN2ViZDQxMGQxYTRlIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmFkbWluMSJ9.I77-J5pbnCNEdyHB3gY-S-7YbdDgtTJb0Qb50pEANOaNZ4NNdLM-iUg8MzwqNwscle3p1s-tkjZseR0GPA079v-Bm33K9BY5--KIjmspSFFQJDjBOxf1X_XLJWltv5JJ9TqQBnxoKHYp5rSSe2hzpTmkz61JcuGAejNK6GTS_rc6tg9L_OzGiLOlES45bx75vMaLZVUeNSY2Ffom2ohMiPFJIpxrPvjBxvnpUoULYLsvEwnTNOydDsBW6dHZrbzjbmTd21sNpWA6nuE7kPRRVYWEJBd_UYOR5FRPNEwZnbvIwPMjKMAHybtM7TjRnHRbpJtR7BDtXbG2InzjXsPt1w"  
   # 节点URL地址 192.168.138.201  
   cluster_server_url = "https://10.24.194.229:6443"  
   bearer_token = get_api_server_token(api_server_token, cluster_server_url)  
   pod_m = pod_manager(cluster_server_url, bearer_token)  
   #创建Pod  
   print("--------create pod with a yaml file ------------")  
   pod_m.create_pod(yamlFile="nginx-pod.yaml",namespace="kube-system")  
   name = "pod-nginx"  
   #查找Pod  
   print("--------get pod with name ------------")  
   #pod_m.get_pod(name)  
   #更新Pod  
   print("--------update_pod pod with name ------------")  
   #pod_m.update_pod(pod_name=name,yamlFile="nginx-pod.yaml",namespace="kube-system")  
   # 删除Pod  
   print("--------delete pod with name ------------")  
   #pod_m.delete_pod(pod_name=name)
```

（2） 代码验证

创建Pod运行结果如下：

```python
[root@master ~]# python3 api_pod_manager.py 
--------create pod with a yaml file ------------
/usr/local/lib/python3.6/site-packages/urllib3/connectionpool.py:1050: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.24.194.229'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/1.26.x/advanced-usage.html#ssl-warnings
  InsecureRequestWarning,
2022-04-13 14:39:20,846 返回信息:{'kind': 'Pod', 'apiVersion': 'v1', 'metadata': {'name': 'pod-nginx', 'namespace': 'kube-system', 'uid': '19a78d35-b165-45b6-b536-cd9c4103154a', 'resourceVersion': '2890', 'creationTimestamp': '2022-04-13T06:39:20Z', 'managedFields': [{'manager': 'python-requests', 'operation': 'Update', 'apiVersion': 'v1', 'time': '2022-04-13T06:39:20Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:spec': {'f:containers': {'k:{"name":"nginx"}': {'.': {}, 'f:image': {}, 'f:imagePullPolicy': {}, 'f:name': {}, 'f:ports': {'.': {}, 'k:{"containerPort":8080,"protocol":"TCP"}': {'.': {}, 'f:containerPort': {}, 'f:protocol': {}}}, 'f:resources': {}, 'f:terminationMessagePath': {}, 'f:terminationMessagePolicy': {}}}, 'f:dnsPolicy': {}, 'f:enableServiceLinks': {}, 'f:restartPolicy': {}, 'f:schedulerName': {}, 'f:securityContext': {}, 'f:terminationGracePeriodSeconds': {}}}}]}, 'spec': {'volumes': [{'name': 'kube-api-access-s9xl6', 'projected': {'sources': [{'serviceAccountToken': {'expirationSeconds': 3607, 'path': 'token'}}, {'configMap': {'name': 'kube-root-ca.crt', 'items': [{'key': 'ca.crt', 'path': 'ca.crt'}]}}, {'downwardAPI': {'items': [{'path': 'namespace', 'fieldRef': {'apiVersion': 'v1', 'fieldPath': 'metadata.namespace'}}]}}], 'defaultMode': 420}}], 'containers': [{'name': 'nginx', 'image': 'nginx:1.15.4', 'ports': [{'containerPort': 8080, 'protocol': 'TCP'}], 'resources': {}, 'volumeMounts': [{'name': 'kube-api-access-s9xl6', 'readOnly': True, 'mountPath': '/var/run/secrets/kubernetes.io/serviceaccount'}], 'terminationMessagePath': '/dev/termination-log', 'terminationMessagePolicy': 'File', 'imagePullPolicy': 'IfNotPresent'}], 'restartPolicy': 'Always', 'terminationGracePeriodSeconds': 30, 'dnsPolicy': 'ClusterFirst', 'serviceAccountName': 'default', 'serviceAccount': 'default', 'securityContext': {}, 'schedulerName': 'default-scheduler', 'tolerations': [{'key': 'node.kubernetes.io/not-ready', 'operator': 'Exists', 'effect': 'NoExecute', 'tolerationSeconds': 300}, {'key': 'node.kubernetes.io/unreachable', 'operator': 'Exists', 'effect': 'NoExecute', 'tolerationSeconds': 300}], 'priority': 0, 'enableServiceLinks': True, 'preemptionPolicy': 'PreemptLowerPriority'}, 'status': {'phase': 'Pending', 'qosClass': 'BestEffort'}}
--------get pod with name ------------
--------update_pod pod with name ------------
--------delete pod with name ------------
```

可以通过命令行查询验证：

```python
[root@master ~]# kubectl get pods -n kube-system  
NAME                             READY   STATUS    RESTARTS      AGE
coredns-78fcd69978-hbtr6         1/1     Running   3 (13m ago)   14m
coredns-78fcd69978-nfbf2         1/1     Running   2 (14m ago)   14m
etcd-master                      1/1     Running   0             14m
kube-apiserver-master            1/1     Running   0             14m
kube-controller-manager-master   1/1     Running   0             14m
kube-flannel-ds-dwwfp            1/1     Running   0             14m
kube-multus-ds-qjgg7             1/1     Running   0             13m
kube-proxy-468cx                 1/1     Running   0             14m
kube-scheduler-master            1/1     Running   0             14m
pod-nginx                        1/1     Running   0             4m34s
```

注释掉创建，进行查询测试：

```python
[root@master ~]# cat api_pod_manager.py  
...
...
...
   #创建Pod  
   print("--------create pod with a yaml file ------------")  
   #pod_m.create_pod(yamlFile="nginx-pod.yaml",namespace="kube-system")  
   name = "pod-nginx"  
   #查找Pod  
   print("--------get pod with name ------------")  
   pod_m.get_pod(name)  
   #更新Pod  
   print("--------update_pod pod with name ------------")  
   #pod_m.update_pod(pod_name=name,yamlFile="nginx-pod.yaml",namespace="kube-system")  
   # 删除Pod  
   print("--------delete pod with name ------------")  
   #pod_m.delete_pod(pod_name=name)  
[root@master ~]# python3 api_pod_manager.py 
--------create pod with a yaml file ------------
--------get pod with name ------------
/usr/local/lib/python3.6/site-packages/urllib3/connectionpool.py:1050: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.24.194.229'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/1.26.x/advanced-usage.html#ssl-warnings
  InsecureRequestWarning,
2022-04-13 14:47:22,116 返回信息:{'kind': 'Pod', 'apiVersion': 'v1', 'metadata': {'name': 'pod-nginx', 'namespace': 'kube-system', 'uid': '19a78d35-b165-45b6-b536-cd9c4103154a', 'resourceVersion': '3678', 'creationTimestamp': '2022-04-13T06:39:20Z', 'annotations': {'k8s.v1.cni.cncf.io/network-status': '[{\n    "name": "cbr0",\n    "interface": "eth0",\n    "ips": [\n        "10.244.0.20"\n    ],\n    "mac": "46:6c:af:28:72:75",\n    "default": true,\n    "dns": {}\n}]', 'k8s.v1.cni.cncf.io/networks-status': '[{\n    "name": "cbr0",\n    "interface": "eth0",\n    "ips": [\n        "10.244.0.20"\n    ],\n    "mac": "46:6c:af:28:72:75",\n    "default": true,\n    "dns": {}\n}]'}, 'managedFields': [{'manager': 'python-requests', 'operation': 'Update', 'apiVersion': 'v1', 'time': '2022-04-13T06:39:20Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:spec': {'f:containers': {'k:{"name":"nginx"}': {'.': {}, 'f:image': {}, 'f:imagePullPolicy': {}, 'f:name': {}, 'f:ports': {'.': {}, 'k:{"containerPort":8080,"protocol":"TCP"}': {'.': {}, 'f:containerPort': {}, 'f:protocol': {}}}, 'f:resources': {}, 'f:terminationMessagePath': {}, 'f:terminationMessagePolicy': {}}}, 'f:dnsPolicy': {}, 'f:enableServiceLinks': {}, 'f:restartPolicy': {}, 'f:schedulerName': {}, 'f:securityContext': {}, 'f:terminationGracePeriodSeconds': {}}}}, {'manager': 'multus', 'operation': 'Update', 'apiVersion': 'v1', 'time': '2022-04-13T06:39:21Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:metadata': {'f:annotations': {'.': {}, 'f:k8s.v1.cni.cncf.io/network-status': {}, 'f:k8s.v1.cni.cncf.io/networks-status': {}}}}, 'subresource': 'status'}, {'manager': 'kubelet', 'operation': 'Update', 'apiVersion': 'v1', 'time': '2022-04-13T06:43:53Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:status': {'f:conditions': {'k:{"type":"ContainersReady"}': {'.': {}, 'f:lastProbeTime': {}, 'f:lastTransitionTime': {}, 'f:status': {}, 'f:type': {}}, 'k:{"type":"Initialized"}': {'.': {}, 'f:lastProbeTime': {}, 'f:lastTransitionTime': {}, 'f:status': {}, 'f:type': {}}, 'k:{"type":"Ready"}': {'.': {}, 'f:lastProbeTime': {}, 'f:lastTransitionTime': {}, 'f:status': {}, 'f:type': {}}}, 'f:containerStatuses': {}, 'f:hostIP': {}, 'f:phase': {}, 'f:podIP': {}, 'f:podIPs': {'.': {}, 'k:{"ip":"10.244.0.20"}': {'.': {}, 'f:ip': {}}}, 'f:startTime': {}}}, 'subresource': 'status'}]}, 'spec': {'volumes': [{'name': 'kube-api-access-s9xl6', 'projected': {'sources': [{'serviceAccountToken': {'expirationSeconds': 3607, 'path': 'token'}}, {'configMap': {'name': 'kube-root-ca.crt', 'items': [{'key': 'ca.crt', 'path': 'ca.crt'}]}}, {'downwardAPI': {'items': [{'path': 'namespace', 'fieldRef': {'apiVersion': 'v1', 'fieldPath': 'metadata.namespace'}}]}}], 'defaultMode': 420}}], 'containers': [{'name': 'nginx', 'image': 'nginx:1.15.4', 'ports': [{'containerPort': 8080, 'protocol': 'TCP'}], 'resources': {}, 'volumeMounts': [{'name': 'kube-api-access-s9xl6', 'readOnly': True, 'mountPath': '/var/run/secrets/kubernetes.io/serviceaccount'}], 'terminationMessagePath': '/dev/termination-log', 'terminationMessagePolicy': 'File', 'imagePullPolicy': 'IfNotPresent'}], 'restartPolicy': 'Always', 'terminationGracePeriodSeconds': 30, 'dnsPolicy': 'ClusterFirst', 'serviceAccountName': 'default', 'serviceAccount': 'default', 'nodeName': 'master', 'securityContext': {}, 'schedulerName': 'default-scheduler', 'tolerations': [{'key': 'node.kubernetes.io/not-ready', 'operator': 'Exists', 'effect': 'NoExecute', 'tolerationSeconds': 300}, {'key': 'node.kubernetes.io/unreachable', 'operator': 'Exists', 'effect': 'NoExecute', 'tolerationSeconds': 300}], 'priority': 0, 'enableServiceLinks': True, 'preemptionPolicy': 'PreemptLowerPriority'}, 'status': {'phase': 'Running', 'conditions': [{'type': 'Initialized', 'status': 'True', 'lastProbeTime': None, 'lastTransitionTime': '2022-04-13T06:39:20Z'}, {'type': 'Ready', 'status': 'True', 'lastProbeTime': None, 'lastTransitionTime': '2022-04-13T06:43:53Z'}, {'type': 'ContainersReady', 'status': 'True', 'lastProbeTime': None, 'lastTransitionTime': '2022-04-13T06:43:53Z'}, {'type': 'PodScheduled', 'status': 'True', 'lastProbeTime': None, 'lastTransitionTime': '2022-04-13T06:39:20Z'}], 'hostIP': '10.24.194.229', 'podIP': '10.244.0.20', 'podIPs': [{'ip': '10.244.0.20'}], 'startTime': '2022-04-13T06:39:20Z', 'containerStatuses': [{'name': 'nginx', 'state': {'running': {'startedAt': '2022-04-13T06:43:53Z'}}, 'lastState': {}, 'ready': True, 'restartCount': 0, 'image': 'nginx:1.15.4', 'imageID': 'docker://sha256:bc26f1ed35cf942745343c09475050f0e4529f785efcfcba784d46296d5842c8', 'containerID': 'docker://a3a238e573858f72e8070acdb07228614a23f140d0a8bb3305cf75d60f22528b', 'started': True}], 'qosClass': 'BestEffort'}}
--------update_pod pod with name ------------
--------delete pod with name ------------
```

更新与删除同样操作进行测试。

#### 2. Deployment资源管理

（1） 代码实现

创建nginx-deployment.yaml文件，用于创建内容如下：

```yaml
[root@master ~]# cat nginx-deployment.yaml 
apiVersion: apps/v1  
kind: Deployment  
metadata:  
  name: nginx-deployment  
  labels:  
    app: nginx  
spec:  
  replicas: 3  
  selector:  
    matchLabels:  
      app: nginx  
  template:  
    metadata:  
      labels:  
        app: nginx  
    spec:  
      containers:  
        - name: nginx  
          image: nginx:1.15.4  
          ports:  
          - containerPort: 80  
```

再创建一个nginx-deployment-update.yaml，用于测试更新service：

```
[root@master ~]# cat nginx-deployment-update.yaml 
spec:  
  containers:  
    - name: nginx  
      image: nginx:1.16  
```

创建api_deployment_manager.py，进行deployment的增删查改操作，代码如下：

```
[root@master ~]# cat api_deployment_manager.py
import requests,time  
import logging  
import os,yaml,json  
#-----------logger-----------  
#get logger  
logger = logging.getLogger(__name__)  
# level  
logger.setLevel(logging.DEBUG)  
# format  
format = logging.Formatter('%(asctime)s %(message)s')  
# to console  
stream_handler  = logging.StreamHandler()  
stream_handler .setFormatter(format)  
logger.addHandler(stream_handler )  
#-----------logger-----------  
def get_api_server_token(api_server_token, node_url):  
     # Bearer token  
  bearer_token = "bearer " + api_server_token  
  return bearer_token  
class api_deployment_manager():  
  def __init__(self,node_url: str, bearer_token: str):  
      self.node_url = node_url  
      self.bearer_token = bearer_token  
   #调用API创建deployment  
  def create_deployment(self,yamlFile,namespace:str):  
      headers = {  
           "Authorization": self.bearer_token,  
           "Content-Type": "application/json"  
      }  
       # 读取yaml文件，并转化为JSON数据  
      with open(yamlFile, encoding="utf8") as f:  
          body = json.dumps(yaml.safe_load(f))  
      request_url = self.node_url + "/apis/apps/v1/namespaces/" + namespace + "/deployments"  
      result = json.loads(requests.post(request_url, data=body, headers=headers, verify=False).text)  
      logger.debug(f"返回信息:{str(result)}")  
      return result  
   #获取deployment，如果想指定获取某个deployment的信息，可以加上deployment_name,若不想则去掉。  
  def get_deployment(self,deployment_name:str, namespace:str):  
      headers = {  
           "Authorization": self.bearer_token,  
           "Content-Type": "application/json"  
      }  
       # GET /apis/apps/v1/namespaces/{namespace}/deployments  
      request_url = self.node_url + "/apis/apps/v1/namespaces/" + namespace + "/deployments/" + deployment_name  
      result = json.loads(requests.get(request_url, headers=headers, verify=False).text)  
      logger.debug(f"返回信息:{str(result)}")  
      return result  
   #更新deployment镜像为1.16  
  def update_deployment(self,deployment_name:str,yamlFile:str, namespace:str):  
      headers = {  
           "Authorization": self.bearer_token,  
           "Content-Type": "application/strategic-merge-patch+json"  
      }  
       #body = {"spec": {"template": {"spec": {"containers": [{"name": "nginx", "image": "nginx:1.16"}]}}}}  
      with open(yamlFile, encoding="utf8") as f:  
          body = json.dumps(yaml.safe_load(f))  
      request_url = self.node_url + "/apis/apps/v1/namespaces/" + namespace + "/deployments/" + deployment_name  
      result = json.loads(requests.put(request_url, data=json.dumps(body), headers=headers, verify=False).text)  
      logger.debug(f"返回信息:{str(result)}")  
      return result  
   #删除deployment  
  def delete_deployment(self,deployment_name:str, namespace:str):  
      headers = {  
           "Authorization": self.bearer_token,  
           "Content-Type": "application/strategic-merge-patch+json"  
      }  
      request_url = self.node_url + "/apis/apps/v1/namespaces/" + namespace + "/deployments/" + deployment_name  
      result = json.loads(requests.delete(request_url, headers=headers, verify=False).text)  
      logger.debug(f"返回信息:{str(result)}")  
      return result  
if __name__ == "__main__":  
   # 将获取到的token值放到api_server_token中去  
  api_server_token = "eyJhbGciOiJSUzI1NiIsImtpZCI6IjNBN0lTYmJQWERIdVNlbGl5Rk5TVFpOLVozQTlTMU5WQUs3UERfSzRnVG8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbjEtdG9rZW4tdjhoNXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiYWRtaW4xIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNzViMzA4YjgtNDY1My00Y2RlLWI0YzEtN2ViZDQxMGQxYTRlIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmFkbWluMSJ9.I77-J5pbnCNEdyHB3gY-S-7YbdDgtTJb0Qb50pEANOaNZ4NNdLM-iUg8MzwqNwscle3p1s-tkjZseR0GPA079v-Bm33K9BY5--KIjmspSFFQJDjBOxf1X_XLJWltv5JJ9TqQBnxoKHYp5rSSe2hzpTmkz61JcuGAejNK6GTS_rc6tg9L_OzGiLOlES45bx75vMaLZVUeNSY2Ffom2ohMiPFJIpxrPvjBxvnpUoULYLsvEwnTNOydDsBW6dHZrbzjbmTd21sNpWA6nuE7kPRRVYWEJBd_UYOR5FRPNEwZnbvIwPMjKMAHybtM7TjRnHRbpJtR7BDtXbG2InzjXsPt1w"  
   # 节点URL地址 192.168.138.201  
  cluster_server_url = "https://10.24.194.229:6443"  
  bearer_token = get_api_server_token(api_server_token, cluster_server_url)  
  dep_m = api_deployment_manager(cluster_server_url,bearer_token)  
  deployment_name = "nginx-deployment"  
   # 创建deployment  
  print("create deployment-------------------")  
  result = dep_m.create_deployment(yamlFile="nginx-deployment.yaml", namespace="default")  
  print(result)  
   # 获取deployment  
  print("get deployment-------------------")  
  result = dep_m.get_deployment(deployment_name,namespace="default")  
  print(result)  
   # 更新deployment  
  print("update deployment-------------------")  
  dep_m.update_deployment(deployment_name=deployment_name,yamlFile="nginx-deployment-update.yaml", namespace="default")  
   # 删除deployment  
  print("delete deployment-------------------")  
  #result = dep_m.delete_deployment(deployment_name=deployment_name,namespace="default")  
# print(result)
```

（2） 代码验证

Deployment资源管理执行结果如下：

```
[root@master ~]# python3 api_deployment_manager.py 
create deployment-------------------
/usr/local/lib/python3.6/site-packages/urllib3/connectionpool.py:1050: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.24.194.229'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/1.26.x/advanced-usage.html#ssl-warnings
  InsecureRequestWarning,
2022-04-13 14:59:12,733 返回信息:{'kind': 'Deployment', 'apiVersion': 'apps/v1', 'metadata': {'name': 'nginx-deployment', 'namespace': 'default', 'uid': 'a094e590-c6ed-4906-a391-7cc867f103ba', 'resourceVersion': '6183', 'generation': 1, 'creationTimestamp': '2022-04-13T06:59:12Z', 'labels': {'app': 'nginx'}, 'managedFields': [{'manager': 'python-requests', 'operation': 'Update', 'apiVersion': 'apps/v1', 'time': '2022-04-13T06:59:12Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:metadata': {'f:labels': {'.': {}, 'f:app': {}}}, 'f:spec': {'f:progressDeadlineSeconds': {}, 'f:replicas': {}, 'f:revisionHistoryLimit': {}, 'f:selector': {}, 'f:strategy': {'f:rollingUpdate': {'.': {}, 'f:maxSurge': {}, 'f:maxUnavailable': {}}, 'f:type': {}}, 'f:template': {'f:metadata': {'f:labels': {'.': {}, 'f:app': {}}}, 'f:spec': {'f:containers': {'k:{"name":"nginx"}': {'.': {}, 'f:image': {}, 'f:imagePullPolicy': {}, 'f:name': {}, 'f:ports': {'.': {}, 'k:{"containerPort":80,"protocol":"TCP"}': {'.': {}, 'f:containerPort': {}, 'f:protocol': {}}}, 'f:resources': {}, 'f:terminationMessagePath': {}, 'f:terminationMessagePolicy': {}}}, 'f:dnsPolicy': {}, 'f:restartPolicy': {}, 'f:schedulerName': {}, 'f:securityContext': {}, 'f:terminationGracePeriodSeconds': {}}}}}}]}, 'spec': {'replicas': 3, 'selector': {'matchLabels': {'app': 'nginx'}}, 'template': {'metadata': {'creationTimestamp': None, 'labels': {'app': 'nginx'}}, 'spec': {'containers': [{'name': 'nginx', 'image': 'nginx:1.15.4', 'ports': [{'containerPort': 80, 'protocol': 'TCP'}], 'resources': {}, 'terminationMessagePath': '/dev/termination-log', 'terminationMessagePolicy': 'File', 'imagePullPolicy': 'IfNotPresent'}], 'restartPolicy': 'Always', 'terminationGracePeriodSeconds': 30, 'dnsPolicy': 'ClusterFirst', 'securityContext': {}, 'schedulerName': 'default-scheduler'}}, 'strategy': {'type': 'RollingUpdate', 'rollingUpdate': {'maxUnavailable': '25%', 'maxSurge': '25%'}}, 'revisionHistoryLimit': 10, 'progressDeadlineSeconds': 600}, 'status': {}}
{'kind': 'Deployment', 'apiVersion': 'apps/v1', 'metadata': {'name': 'nginx-deployment', 'namespace': 'default', 'uid': 'a094e590-c6ed-4906-a391-7cc867f103ba', 'resourceVersion': '6183', 'generation': 1, 'creationTimestamp': '2022-04-13T06:59:12Z', 'labels': {'app': 'nginx'}, 'managedFields': [{'manager': 'python-requests', 'operation': 'Update', 'apiVersion': 'apps/v1', 'time': '2022-04-13T06:59:12Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:metadata': {'f:labels': {'.': {}, 'f:app': {}}}, 'f:spec': {'f:progressDeadlineSeconds': {}, 'f:replicas': {}, 'f:revisionHistoryLimit': {}, 'f:selector': {}, 'f:strategy': {'f:rollingUpdate': {'.': {}, 'f:maxSurge': {}, 'f:maxUnavailable': {}}, 'f:type': {}}, 'f:template': {'f:metadata': {'f:labels': {'.': {}, 'f:app': {}}}, 'f:spec': {'f:containers': {'k:{"name":"nginx"}': {'.': {}, 'f:image': {}, 'f:imagePullPolicy': {}, 'f:name': {}, 'f:ports': {'.': {}, 'k:{"containerPort":80,"protocol":"TCP"}': {'.': {}, 'f:containerPort': {}, 'f:protocol': {}}}, 'f:resources': {}, 'f:terminationMessagePath': {}, 'f:terminationMessagePolicy': {}}}, 'f:dnsPolicy': {}, 'f:restartPolicy': {}, 'f:schedulerName': {}, 'f:securityContext': {}, 'f:terminationGracePeriodSeconds': {}}}}}}]}, 'spec': {'replicas': 3, 'selector': {'matchLabels': {'app': 'nginx'}}, 'template': {'metadata': {'creationTimestamp': None, 'labels': {'app': 'nginx'}}, 'spec': {'containers': [{'name': 'nginx', 'image': 'nginx:1.15.4', 'ports': [{'containerPort': 80, 'protocol': 'TCP'}], 'resources': {}, 'terminationMessagePath': '/dev/termination-log', 'terminationMessagePolicy': 'File', 'imagePullPolicy': 'IfNotPresent'}], 'restartPolicy': 'Always', 'terminationGracePeriodSeconds': 30, 'dnsPolicy': 'ClusterFirst', 'securityContext': {}, 'schedulerName': 'default-scheduler'}}, 'strategy': {'type': 'RollingUpdate', 'rollingUpdate': {'maxUnavailable': '25%', 'maxSurge': '25%'}}, 'revisionHistoryLimit': 10, 'progressDeadlineSeconds': 600}, 'status': {}}
get deployment-------------------
/usr/local/lib/python3.6/site-packages/urllib3/connectionpool.py:1050: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.24.194.229'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/1.26.x/advanced-usage.html#ssl-warnings
  InsecureRequestWarning,
2022-04-13 14:59:12,762 返回信息:{'kind': 'Deployment', 'apiVersion': 'apps/v1', 'metadata': {'name': 'nginx-deployment', 'namespace': 'default', 'uid': 'a094e590-c6ed-4906-a391-7cc867f103ba', 'resourceVersion': '6193', 'generation': 1, 'creationTimestamp': '2022-04-13T06:59:12Z', 'labels': {'app': 'nginx'}, 'annotations': {'deployment.kubernetes.io/revision': '1'}, 'managedFields': [{'manager': 'kube-controller-manager', 'operation': 'Update', 'apiVersion': 'apps/v1', 'time': '2022-04-13T06:59:12Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:metadata': {'f:annotations': {'.': {}, 'f:deployment.kubernetes.io/revision': {}}}, 'f:status': {'f:conditions': {'.': {}, 'k:{"type":"Available"}': {'.': {}, 'f:lastTransitionTime': {}, 'f:lastUpdateTime': {}, 'f:message': {}, 'f:reason': {}, 'f:status': {}, 'f:type': {}}, 'k:{"type":"Progressing"}': {'.': {}, 'f:lastTransitionTime': {}, 'f:lastUpdateTime': {}, 'f:message': {}, 'f:reason': {}, 'f:status': {}, 'f:type': {}}}, 'f:observedGeneration': {}, 'f:unavailableReplicas': {}}}, 'subresource': 'status'}, {'manager': 'python-requests', 'operation': 'Update', 'apiVersion': 'apps/v1', 'time': '2022-04-13T06:59:12Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:metadata': {'f:labels': {'.': {}, 'f:app': {}}}, 'f:spec': {'f:progressDeadlineSeconds': {}, 'f:replicas': {}, 'f:revisionHistoryLimit': {}, 'f:selector': {}, 'f:strategy': {'f:rollingUpdate': {'.': {}, 'f:maxSurge': {}, 'f:maxUnavailable': {}}, 'f:type': {}}, 'f:template': {'f:metadata': {'f:labels': {'.': {}, 'f:app': {}}}, 'f:spec': {'f:containers': {'k:{"name":"nginx"}': {'.': {}, 'f:image': {}, 'f:imagePullPolicy': {}, 'f:name': {}, 'f:ports': {'.': {}, 'k:{"containerPort":80,"protocol":"TCP"}': {'.': {}, 'f:containerPort': {}, 'f:protocol': {}}}, 'f:resources': {}, 'f:terminationMessagePath': {}, 'f:terminationMessagePolicy': {}}}, 'f:dnsPolicy': {}, 'f:restartPolicy': {}, 'f:schedulerName': {}, 'f:securityContext': {}, 'f:terminationGracePeriodSeconds': {}}}}}}]}, 'spec': {'replicas': 3, 'selector': {'matchLabels': {'app': 'nginx'}}, 'template': {'metadata': {'creationTimestamp': None, 'labels': {'app': 'nginx'}}, 'spec': {'containers': [{'name': 'nginx', 'image': 'nginx:1.15.4', 'ports': [{'containerPort': 80, 'protocol': 'TCP'}], 'resources': {}, 'terminationMessagePath': '/dev/termination-log', 'terminationMessagePolicy': 'File', 'imagePullPolicy': 'IfNotPresent'}], 'restartPolicy': 'Always', 'terminationGracePeriodSeconds': 30, 'dnsPolicy': 'ClusterFirst', 'securityContext': {}, 'schedulerName': 'default-scheduler'}}, 'strategy': {'type': 'RollingUpdate', 'rollingUpdate': {'maxUnavailable': '25%', 'maxSurge': '25%'}}, 'revisionHistoryLimit': 10, 'progressDeadlineSeconds': 600}, 'status': {'observedGeneration': 1, 'unavailableReplicas': 3, 'conditions': [{'type': 'Progressing', 'status': 'True', 'lastUpdateTime': '2022-04-13T06:59:12Z', 'lastTransitionTime': '2022-04-13T06:59:12Z', 'reason': 'NewReplicaSetCreated', 'message': 'Created new replica set "nginx-deployment-746ccc65d8"'}, {'type': 'Available', 'status': 'False', 'lastUpdateTime': '2022-04-13T06:59:12Z', 'lastTransitionTime': '2022-04-13T06:59:12Z', 'reason': 'MinimumReplicasUnavailable', 'message': 'Deployment does not have minimum availability.'}]}}
{'kind': 'Deployment', 'apiVersion': 'apps/v1', 'metadata': {'name': 'nginx-deployment', 'namespace': 'default', 'uid': 'a094e590-c6ed-4906-a391-7cc867f103ba', 'resourceVersion': '6193', 'generation': 1, 'creationTimestamp': '2022-04-13T06:59:12Z', 'labels': {'app': 'nginx'}, 'annotations': {'deployment.kubernetes.io/revision': '1'}, 'managedFields': [{'manager': 'kube-controller-manager', 'operation': 'Update', 'apiVersion': 'apps/v1', 'time': '2022-04-13T06:59:12Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:metadata': {'f:annotations': {'.': {}, 'f:deployment.kubernetes.io/revision': {}}}, 'f:status': {'f:conditions': {'.': {}, 'k:{"type":"Available"}': {'.': {}, 'f:lastTransitionTime': {}, 'f:lastUpdateTime': {}, 'f:message': {}, 'f:reason': {}, 'f:status': {}, 'f:type': {}}, 'k:{"type":"Progressing"}': {'.': {}, 'f:lastTransitionTime': {}, 'f:lastUpdateTime': {}, 'f:message': {}, 'f:reason': {}, 'f:status': {}, 'f:type': {}}}, 'f:observedGeneration': {}, 'f:unavailableReplicas': {}}}, 'subresource': 'status'}, {'manager': 'python-requests', 'operation': 'Update', 'apiVersion': 'apps/v1', 'time': '2022-04-13T06:59:12Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:metadata': {'f:labels': {'.': {}, 'f:app': {}}}, 'f:spec': {'f:progressDeadlineSeconds': {}, 'f:replicas': {}, 'f:revisionHistoryLimit': {}, 'f:selector': {}, 'f:strategy': {'f:rollingUpdate': {'.': {}, 'f:maxSurge': {}, 'f:maxUnavailable': {}}, 'f:type': {}}, 'f:template': {'f:metadata': {'f:labels': {'.': {}, 'f:app': {}}}, 'f:spec': {'f:containers': {'k:{"name":"nginx"}': {'.': {}, 'f:image': {}, 'f:imagePullPolicy': {}, 'f:name': {}, 'f:ports': {'.': {}, 'k:{"containerPort":80,"protocol":"TCP"}': {'.': {}, 'f:containerPort': {}, 'f:protocol': {}}}, 'f:resources': {}, 'f:terminationMessagePath': {}, 'f:terminationMessagePolicy': {}}}, 'f:dnsPolicy': {}, 'f:restartPolicy': {}, 'f:schedulerName': {}, 'f:securityContext': {}, 'f:terminationGracePeriodSeconds': {}}}}}}]}, 'spec': {'replicas': 3, 'selector': {'matchLabels': {'app': 'nginx'}}, 'template': {'metadata': {'creationTimestamp': None, 'labels': {'app': 'nginx'}}, 'spec': {'containers': [{'name': 'nginx', 'image': 'nginx:1.15.4', 'ports': [{'containerPort': 80, 'protocol': 'TCP'}], 'resources': {}, 'terminationMessagePath': '/dev/termination-log', 'terminationMessagePolicy': 'File', 'imagePullPolicy': 'IfNotPresent'}], 'restartPolicy': 'Always', 'terminationGracePeriodSeconds': 30, 'dnsPolicy': 'ClusterFirst', 'securityContext': {}, 'schedulerName': 'default-scheduler'}}, 'strategy': {'type': 'RollingUpdate', 'rollingUpdate': {'maxUnavailable': '25%', 'maxSurge': '25%'}}, 'revisionHistoryLimit': 10, 'progressDeadlineSeconds': 600}, 'status': {'observedGeneration': 1, 'unavailableReplicas': 3, 'conditions': [{'type': 'Progressing', 'status': 'True', 'lastUpdateTime': '2022-04-13T06:59:12Z', 'lastTransitionTime': '2022-04-13T06:59:12Z', 'reason': 'NewReplicaSetCreated', 'message': 'Created new replica set "nginx-deployment-746ccc65d8"'}, {'type': 'Available', 'status': 'False', 'lastUpdateTime': '2022-04-13T06:59:12Z', 'lastTransitionTime': '2022-04-13T06:59:12Z', 'reason': 'MinimumReplicasUnavailable', 'message': 'Deployment does not have minimum availability.'}]}}
update deployment-------------------
/usr/local/lib/python3.6/site-packages/urllib3/connectionpool.py:1050: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.24.194.229'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/1.26.x/advanced-usage.html#ssl-warnings
  InsecureRequestWarning,
2022-04-13 14:59:12,783 返回信息:{'kind': 'Status', 'apiVersion': 'v1', 'metadata': {}, 'status': 'Failure', 'message': 'the body of the request was in an unknown format - accepted media types include: application/json, application/yaml, application/vnd.kubernetes.protobuf', 'reason': 'UnsupportedMediaType', 'code': 415}
delete deployment-------------------
```

通过控制平台查询结果如下：

```
[root@master ~]# kubectl get deployments -n default  
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           72s
```

#### 3. Service 资源管理

（1） 代码实现

创建service.yaml文件，用于创建内容如下：

```
[root@master ~]# cat service.yaml 
apiVersion: v1  
kind: Service  
metadata:  
  name: nginx-svc  
  namespace: default  
spec:  
  selector:  
    app: nginx  
  ports:  
    - port: 80  
      targetPort: 80  
      nodePort: 30088 
  type: NodePort  
```

再创建一个update_service.yaml，用于测试更新service。

```
[root@master ~]# cat update_service.yaml 
spec:  
ports:  
   - port: 80  
    targetPort: 8089  
```

创建api_service_manager.py，进行Service的增删查改操作，代码如下：

```
[root@master ~]# cat api_service_manager.py
import requests,time  
import logging  
import os,yaml,json  
#-----------logger-----------  
#get logger  
logger = logging.getLogger(__name__)  
# level  
logger.setLevel(logging.DEBUG)  
# format  
format = logging.Formatter('%(asctime)s %(message)s')  
# to console  
stream_handler  = logging.StreamHandler()  
stream_handler .setFormatter(format)  
logger.addHandler(stream_handler )  
#-----------logger-----------  
#服务接口  
#https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#create-service-v1-core  
def get_api_server_token(api_server_token, node_url):  
   # Bearer token  
  bearer_token = "bearer " + api_server_token  
  return bearer_token  
class api_service_manager():  
  def __init__(self,node_url: str, bearer_token: str):  
      self.node_url = node_url  
      self.bearer_token = bearer_token  
   #创建svc  
  def create_svc(self, yamlFile, namespace: str):  
      headers = {  
           "Authorization": self.bearer_token,  
           "Content-Type": "application/json"  
      }  
       # 读取yaml文件，并转化为JSON数据  
      with open(yamlFile, encoding="utf8") as f:  
          body = json.dumps(yaml.safe_load(f))  
      request_url = self.node_url + "/api/v1/namespaces/" + namespace + "/services"  
      result = json.loads(requests.post(request_url, data=body, headers=headers, verify=False).text)  
      logger.debug(f"返回信息:{str(result)}")  
      return result  
   #获取svc，如果想指定获取某个svc的信息，可以加上svc_name,若不想则去掉。  
  def get_svc(self,svc_name:str,namespace:str):  
      headers = {  
           "Authorization": self.bearer_token,  
           "pretty" : "true"  
      }  
      request_url = self.node_url + "/api/v1/namespaces/" + namespace + "/services/" + svc_name  
      result = json.loads(requests.get(request_url, headers=headers, verify=False).text)  
      logger.debug(f"返回信息:{str(result)}")  
      return result  
   #更改svc,将targetPort从80更改为8080  
  def update_svc(self,svc_name:str,yamlFile,namespace:str):  
      headers = {  
           "Authorization": self.bearer_token,  
           "Content-Type": "application/strategic-merge-patch+json"  
      }  
      with open(yamlFile, encoding="utf8") as f:  
          body = json.dumps(yaml.safe_load(f))  
       #       '{"spec": {"ports": [{"port": 80, "targetPort": 8089}]}}'  
       # body = {"spec": {"ports": [{"port": 80, "targetPort": 80}]}}  
      request_url = self.node_url + "/api/v1/namespaces/" + namespace + "/services/" + svc_name  
      resp = requests.put(request_url, data=json.dumps(body), headers=headers, verify=False)  
      result = json.loads(resp.text)  
      logger.debug(f"返回信息:{str(result)}")  
      return result  
   #删除svc  
  def delete_svc(self,svc_name:str,namespace:str):  
      headers = {  
           "Authorization": bearer_token  
      }  
      request_url = self.node_url + "/api/v1/namespaces/" + namespace + "/services/" + svc_name  
      result = json.loads(requests.delete(request_url, headers=headers, verify=False).text)  
      logger.debug(f"返回信息:{str(result)}")  
      return result  
if __name__ == "__main__":  
   #使用自建token  
   # 将获取到的token值放到api_server_token中去  
  api_server_token = "eyJhbGciOiJSUzI1NiIsImtpZCI6IjNBN0lTYmJQWERIdVNlbGl5Rk5TVFpOLVozQTlTMU5WQUs3UERfSzRnVG8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbjEtdG9rZW4tdjhoNXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiYWRtaW4xIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNzViMzA4YjgtNDY1My00Y2RlLWI0YzEtN2ViZDQxMGQxYTRlIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmFkbWluMSJ9.I77-J5pbnCNEdyHB3gY-S-7YbdDgtTJb0Qb50pEANOaNZ4NNdLM-iUg8MzwqNwscle3p1s-tkjZseR0GPA079v-Bm33K9BY5--KIjmspSFFQJDjBOxf1X_XLJWltv5JJ9TqQBnxoKHYp5rSSe2hzpTmkz61JcuGAejNK6GTS_rc6tg9L_OzGiLOlES45bx75vMaLZVUeNSY2Ffom2ohMiPFJIpxrPvjBxvnpUoULYLsvEwnTNOydDsBW6dHZrbzjbmTd21sNpWA6nuE7kPRRVYWEJBd_UYOR5FRPNEwZnbvIwPMjKMAHybtM7TjRnHRbpJtR7BDtXbG2InzjXsPt1w"  
   # 节点URL地址 192.168.138.201  
  cluster_server_url = "https://10.24.194.229:6443"  
  bearer_token = get_api_server_token(api_server_token, cluster_server_url)  
  svc_m = api_service_manager(cluster_server_url,bearer_token)  
  namespace = "default"  
  svc_name = "nginx-svc"  
  yaml_file = "service.yaml"  
   #创建svc  
  print("crate ----------------")  
  svc_m.create_svc(yaml_file, namespace)  
   #获取svc  
  print("get ----------------")  
  #svc_m.get_svc(svc_name,namespace)  
   #更新svc  
  print("patch ----------------")  
  #svc_m.update_svc(svc_name,"service_update.yaml", namespace)  
   #删除svc  
  #svc_m.delete_svc(svc_name,namespace)
```

（2） 代码验证

Service资源管理执行结果为：

```
[root@master ~]# python3 api_service_manager.py 
crate ----------------
/usr/local/lib/python3.6/site-packages/urllib3/connectionpool.py:1050: InsecureRequestWarning: Unverified HTTPS request is being made to host '10.24.194.229'. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/1.26.x/advanced-usage.html#ssl-warnings
  InsecureRequestWarning,
2022-04-13 15:09:42,937 返回信息:{'kind': 'Service', 'apiVersion': 'v1', 'metadata': {'name': 'nginx-svc', 'namespace': 'default', 'uid': '03ed3f41-9a41-4683-aedc-19d199ec9501', 'resourceVersion': '7952', 'creationTimestamp': '2022-04-13T07:09:42Z', 'managedFields': [{'manager': 'python-requests', 'operation': 'Update', 'apiVersion': 'v1', 'time': '2022-04-13T07:09:42Z', 'fieldsType': 'FieldsV1', 'fieldsV1': {'f:spec': {'f:externalTrafficPolicy': {}, 'f:internalTrafficPolicy': {}, 'f:ports': {'.': {}, 'k:{"port":80,"protocol":"TCP"}': {'.': {}, 'f:nodePort': {}, 'f:port': {}, 'f:protocol': {}, 'f:targetPort': {}}}, 'f:selector': {}, 'f:sessionAffinity': {}, 'f:type': {}}}}]}, 'spec': {'ports': [{'protocol': 'TCP', 'port': 80, 'targetPort': 80, 'nodePort': 30088}], 'selector': {'app': 'nginx'}, 'clusterIP': '10.96.226.188', 'clusterIPs': ['10.96.226.188'], 'type': 'NodePort', 'sessionAffinity': 'None', 'externalTrafficPolicy': 'Cluster', 'ipFamilies': ['IPv4'], 'ipFamilyPolicy': 'SingleStack', 'internalTrafficPolicy': 'Cluster'}, 'status': {'loadBalancer': {}}}
get ----------------
patch ----------------
```

通过控制平台查询结果如下：

```
[root@master ~]# kubectl get services -n default  
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP        41m
nginx-svc    NodePort    10.96.226.188   <none>        80:30088/TCP   31s
```

**注意：此实验是连续实验，请不要释放实验资源。**