[toc]



# RH358考试

>   **整理时间：20210907**

请查阅以下重要配置信息，以了解考试环境相关的信息。

考试时间4小时。

请注意，考试过程中不能与其他考生交流，您也不得连接到其他考生的主机，测验系统及其网络会受到监控，不当使用可导致成绩判为零分。

请执行下方列出的任务。在开始操作前，您不妨先通读整个列表。这些项目将使用一个分数来评分，这些任务的总分为300分，您必须达到210分或以上才能获得认证。

 

## 重要配置信息

在考试期间，除了您就坐位置的台式机之外，还将使用多个虚拟系统。您不具有台式机系统的根访问权，但具有对虚拟系统的完全 root 访问权。

### 系统信息

|    系统     |    IP地址     |       角色       | LAN1 | LAN2 |
| :---------: | :-----------: | :--------------: | :--: | :--: |
| workstation | 172.25.250.9  | ansible 控制节点 |  Y   |      |
|   servera   | 172.25.250.10 |      server      |  Y   |  Y   |
|   serverb   | 172.25.250.11 |   CMD - client   |  Y   |  Y   |
|   serverc   | 172.25.250.12 | ansbile 托管节点 |  Y   |      |
|   serverd   | 172.25.250.13 | ansible 托管节点 |  Y   |      |

这些系统的IP地址采用静态设置。请勿更改这些设置。主机名称解析已配置为解析上方列出的完全限定主机名，同时也解析主机短名称。

### 帐户信息

-   所有系统的root密码是`redhat`。请勿更改root密码
-   除非另有指定，否则这将是用于访问其他系统和服务的密码。
-   除非另有指定，否则此密码也应用于您创建的所有帐户或者任何需要设置密码的服务。
-   为方便起见，所有系统上已预装了SSH密钥，允许在不输入密码的前提下通过SSH进行root访问。请勿对系统上的root SSH配置文件进行任何修改。
-   **Ansible控制节点上已创建了用户帐户`student` 。**此帐户预装了SSH密钥，允许在Ansible控制节点和各个Ansible受管节点之间进行SSH登录。请勿对系统上的student SSH配置文件进行任何修改。您可以从root帐户使用su访问此用户帐户。

### 其他信息

-   一些考试项目可能需要修改Ansible主机清单。您要负责确保所有以前的清单组和项目保留下来，与任何其他更改共存。您还要有确保清单中所有默认的组和主机保留您进行的任何更改。
-   所有节点，yum存储库已正确配置。
-   一些项目需要额外的文件，这些文件已在以下位置提供：http://materials.example.com/laoma/
-   其他资源也进行了配置，供您在考试期间使用。关于这些资源的具体信息将在需要这些资源的项目中提供。

### 重要评测信息

请注意，在评分之前，您的 Ansible 托管节点系统 将重置为考试开始时的初始状态，您编写的 Ansible playbook 将通过以 **student** 用户身份在控制节点上运行来加以应用。在 playbook 运行后，系统会重新启动您的托管节点，然后进行评估，以判断它们是否按照规定进行了配置。

### 虚拟系统管理

考试期间，您可以随时关闭或重新引导虚拟机系统。您可以从虚拟系统本身进行这项操作，也可以从物理系统控制虚拟系统。要从物理系统访问或控制考试系统，单击桌面上VM控制台图标。这会显示一个表格，包含每个虚拟机系统的对应按钮，单击特定虚拟机系统的按钮将弹出一个菜单，包含用来控制该系统选项：

-   启动节点点VM-如果指定的虚拟系统未在运行，该选项将启动指定系统。如果系统已经在运行-则该选项无任何作用。
-   重新引导节点VM-正常关闭考试虚拟系统，然后重启。
-   关闭节点VM-正常关闭指定虚拟系统。
-   关闭节点VM电源-立即关闭指定虚拟系统。
-   VM控制台节点-这将打开一个窗口，用于连接到指定虚拟系统的控制台。请注意，如果将焦点移动到此窗口，控制台将抓住您的鼠标。要恢复鼠标，同时键入Ctrl+Alt。
-   重建节点VM-将当前VM还原为原始状态。系统将弹出一个单独的窗口，要求您确认操作。警告！！！您在VM上完成的所有操作都将丢失。仅当系统无法使用时才应使用这个功能。在使用这个功能之前，确保关闭VM。

 

## 考试小技巧

1.  仔细检查鼠标和键盘，特别是鼠标右键和中间。
2.  尽可能使用tab键补全。
3.  考试过程中用到的名称、路径等字符串，使用复制粘贴。
4.  保持终端清洁，每做完一个题目，执行clear命令或使用快捷键CTRL+L清屏。
5.  根据需要，打开多个终端，例如查看帮助。

 

## 考前检查

-   YUM仓库
-   时钟同步
-   部署节点student用户免密登录其他节点，并免密提权为root用户

## 考前准备

-   删除servera-d第二块网卡和第三块网卡配置

    ```shell
    [kiosk@foundation0 ~]$ for host in server{a..d}; do ssh root@$host 'nmcli con delete "Wired connection 2";nmcli con delete "Wired connection 3"';done
    ```

-   ```shell
    # 20题准备
    [student@workstation ~]$ lab smtp-automation start
    ```

-   ```shell
    # 21题准备
    [student@workstation ~]$ lab printing-automation start
    ```

    

## 练习题

### 1. 配置IPV6地址

在您的考试系统上配置接口`eth0`使用下列IPv6地址：

-   servera 上的地址应该是`fddb:fe2a:ab1e::c0a8:64/64`
-   serverb 上的地址应该是`fddb:fe2a:ab1e::c0a8:65/64`
-   两个系统必须能与系统`fddb:fe2a:ab1e::c0a8:fe`通信
-   地址必须在重启后依旧生效
-   两个系统必须保持当前的IPv4地址并能通信

 

**准备工作**

```shell
# 获取connection名称
[root@bastion ~]# nmcli connection show
NAME                UUID                                  TYPE      DEVICE 
Wired connection 2  8abe5e01-c25f-372e-b31a-990139a9d0cf  ethernet  eth1   
Wired connection 1  274c086a-01ce-3951-aae6-b2cdc1a97785  ethernet  eth0

# 配置地址
[root@bastion ~]# nmcli con mod "Wired connection 1" ipv6.method manual ipv6.addresses fddb:fe2a:ab1e::c0a8:fe/64
[root@bastion ~]# nmcli con up "Wired connection 1"
```

 

**答题**

```shell
[root@servera ~]# nmcli con mod "Wired connection 1" ipv6.method manual ipv6.addresses fddb:fe2a:ab1e::c0a8:64/64
[root@servera ~]# nmcli con up "Wired connection 1"

[root@serverb ~]# nmcli con mod "Wired connection 1" ipv6.method manual ipv6.addresses fddb:fe2a:ab1e::c0a8:65/64
[root@serverb ~]# nmcli con up "Wired connection 1"
```

 

**测试**

```shell
[root@servera ~]# ping6 -c2 fddb:fe2a:ab1e::c0a8:fe
PING fddb:fe2a:ab1e::c0a8:fe(fddb:fe2a:ab1e::c0a8:fe) 56 data bytes
64 bytes from fddb:fe2a:ab1e::c0a8:fe: icmp_seq=1 ttl=64 time=1.94 ms
64 bytes from fddb:fe2a:ab1e::c0a8:fe: icmp_seq=2 ttl=64 time=0.731 ms

--- fddb:fe2a:ab1e::c0a8:fe ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 2ms
rtt min/avg/max/mdev = 0.731/1.336/1.941/0.605 ms

[root@servera ~]# ping6 -c2 fddb:fe2a:ab1e::c0a8:65
PING fddb:fe2a:ab1e::c0a8:65(fddb:fe2a:ab1e::c0a8:65) 56 data bytes
64 bytes from fddb:fe2a:ab1e::c0a8:65: icmp_seq=1 ttl=64 time=1.95 ms
64 bytes from fddb:fe2a:ab1e::c0a8:65: icmp_seq=2 ttl=64 time=0.644 ms

--- fddb:fe2a:ab1e::c0a8:65 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 2ms
rtt min/avg/max/mdev = 0.644/1.294/1.945/0.651 ms

[root@servera ~]# ping -c2 172.25.250.254
PING 172.25.250.254 (172.25.250.254) 56(84) bytes of data.
64 bytes from 172.25.250.254: icmp_seq=1 ttl=64 time=2.37 ms
64 bytes from 172.25.250.254: icmp_seq=2 ttl=64 time=0.503 ms

--- 172.25.250.254 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 3ms
rtt min/avg/max/mdev = 0.503/1.436/2.370/0.934 ms
```

 

### 2. 配置DHCP服务器

Configure a DHCP server for IPv4 address assignment and provide fixed IP addresses to selected systems.

-   you deploy a DHCP server on `servera`
-   the second interface `eth1`
-   The DHCP server manages the `192.168.0.0/24` subnet
-   delivers IP addresses in the `192.168.0.200` to `192.168.0.254` range
-   broadcast-address `192.168.0.255`
-   gateway `192.168.0.1`
-   domain-name-servers `172.25.254.254`
-   domain-search `example.net`
-   default-lease-time `800`
-   associates the `192.168.0.11` IP address to the `52:54:00:01:fa:0b` MAC address

 

**准备工作**

```shell
[root@servera ~]# nmcli con add con-name eth1 type ethernet ifname eth1 ipv4.method manual ipv4.addresses 192.168.0.10/24
[root@servera ~]# nmcli con up eth1
```

 

**答题**

```shell
# 安装软件包
[root@servera ~]# yum -y install dhcp-server

# 获取软件配置文件清单
[root@servera ~]# rpm -qc dhcp-server
/etc/dhcp/dhcpd.conf
/etc/dhcp/dhcpd6.conf
/etc/openldap/schema/dhcp.schema
/etc/sysconfig/dhcpd
/var/lib/dhcpd/dhcpd.leases
/var/lib/dhcpd/dhcpd6.leases

# 查看帮助文件/etc/sysconfig/dhcpd
[root@servera ~]# cat /etc/sysconfig/dhcpd

# 配置dhcpd.service
[root@servera ~]# cp /usr/lib/systemd/system/dhcpd.service /etc/systemd/system/
[root@servera ~]# vim /etc/systemd/system/dhcpd.service
......
# ExecStart最后$DHCPDARGS更改为eth1，其他保持不变
ExecStart=/usr/sbin/dhcpd -f -cf /etc/dhcp/dhcpd.conf -user dhcpd -group dhcpd --no-pid eth1
......
# 重新读取dhcpd.service配置
[root@servera ~]# systemctl daemon-reload

# 准备DHCP服务器配置文件dhcpd.conf
[root@servera ~]# /bin/cp /usr/share/doc/dhcp-server/dhcpd.conf.example /etc/dhcp/dhcpd.conf
[root@servera ~]# vim /etc/dhcp/dhcpd.conf
authoritative;
log-facility local7;

subnet 192.168.0.0 netmask 255.255.255.0 {
  range 192.168.0.200 192.168.0.254;
  option domain-name-servers 172.25.254.254;
  option domain-name "example.net";
  option routers 192.168.0.1;
  option broadcast-address 192.168.0.255;
  default-lease-time 800;
  max-lease-time 7200;
}

host server11 {
  hardware ethernet 52:54:00:01:fa:0b;
  fixed-address 192.168.0.11;
}
# 测试配置文件语法
[root@servera ~]# dhcpd -t
[root@servera ~]# echo $?
0

# 启用并启动用服务
[root@servera ~]# systemctl enable dhcpd --now

# 配置防火墙
[root@servera ~]# firewall-cmd --add-service=dhcp
[root@servera ~]# firewall-cmd --add-service=dhcp --permanent 
```

 

**测试**

```shel
[root@serverb ~]# nmcli connection add con-name dynamic type ethernet ifname eth1
[root@serverb ~]# nmcli connection up dynamic 
[root@serverb ~]# ip addr show eth1
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 52:54:00:01:fa:0b brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.11/24 brd 192.168.0.255 scope global dynamic noprefixroute eth1
       valid_lft 779sec preferred_lft 779sec
    inet6 fe80::391:caca:8232:9421/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

# 测试完成后，关闭该端口，如果不关闭，serverb将具有2个网关
[root@serverb ~]# nmcli connection down dynamic
```

 

### 3. 配置防火墙

在 `servera` 和 `serverb` 上分别设置，针对SSH

-   允许`172.25.250.0/24` 的域对 servera 和 serverb 进行`SSH` 
-   禁止`172.24.250.0/24` 的域对 servera 和 serverb 进行`SSH`

 

**答题**

```shell
# 删除现有ssh规则
[root@servera ~]# firewall-cmd --remove-service=ssh
[root@servera ~]# firewall-cmd --remove-service=ssh --permanent

# 获取rich rule示例
[root@servera ~]# man -k rich
firewalld.richlanguage (5) - Rich Language Documentation
[root@servera ~]# man firewalld.richlanguage
# 参照Example 3编写


[root@servera ~]# firewall-cmd --add-rich-rule='rule family="ipv4" source address="172.25.250.0/24" service name="ssh" accept' --permanent
[root@servera ~]# firewall-cmd --add-rich-rule='rule family="ipv4" source address="172.24.250.0/24" service name="ssh" reject' --permanent

# serverb做相同的配置
[root@serverb ~]# firewall-cmd --remove-service=ssh --permanent
[root@serverb ~]# firewall-cmd --remove-service=ssh
[root@serverb ~]# firewall-cmd --add-rich-rule='rule family="ipv4" source address="172.25.250.0/24" service name="ssh" accept' --permanent
[root@serverb ~]# firewall-cmd --add-rich-rule='rule family="ipv4" source address="172.25.250.0/24" service name="ssh" accept'
[root@serverb ~]# firewall-cmd --add-rich-rule='rule family="ipv4" source address="172.24.250.0/24" service name="ssh" reject' --permanent
[root@serverb ~]# firewall-cmd --add-rich-rule='rule family="ipv4" source address="172.24.250.0/24" service name="ssh" reject'
```

 

**测试**

```shell
[root@servera ~]# firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0 eth1
  sources: 
  services: cockpit dhcp dhcpv6-client
  ports: 
  protocols: 
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich rules: 
    rule family="ipv4" source address="172.25.250.0/24" service name="ssh" accept
    rule family="ipv4" source address="172.24.250.0/24" service name="ssh" reject

[root@servera ~]# ssh root@serverb
```

 

### 4. 完成主DNS配置

在`servera`配置DNS服务，要求如下：

-   在`servera`配置主DNS
-   配置正向解析`servera`,`serverb` 
-   配置反向解析`172.25.250.10`,`172.25.250.11` 

 

**答题**

```shell
# 安装软件包
[root@servera ~]# yum -y install bind

# 配置named.conf
[root@servera ~]# vim /etc/named.conf
# 修改以下参数，其他保持默认
options {
        listen-on port 53 { any; };
        listen-on-v6 port 53 { any; };
        allow-query     { localhost; any; };
        recursion no;
}

# 文件最后添加如下记录
include "/etc/named.server.conf";

# 参照/etc/named.rfc1912.zones准备文件/etc/named.server.conf
[root@servera ~]# cp /etc/named.rfc1912.zones /etc/named.server.conf
[root@servera ~]# vim /etc/named.server.conf
zone "lab.example.com" IN {
      type master;
      file "lab.example.com.zone";
};

zone "250.25.172.in-addr.arpa" IN {
      type master;
      file "172.25.250.zone";
};
[root@servera ~]# chmod 640 /etc/named.server.conf
[root@servera ~]# chgrp named /etc/named.server.conf

# 创建正向解析文件
[root@servera ~]# cp /var/named/named.localhost /var/named/lab.example.com.zone
[root@servera ~]# vim /var/named/lab.example.com.zone
$TTL 1D
@ IN SOA servera.lab.example.com. laoma.lab.example.com. (
     20210830 ; serial
     1D ; refresh
     1H ; retry
     1W ; expire
     3H ) ; minimum
; owner TTL CL type RDATA
            IN NS servera.lab.example.com.
servera     IN A 172.25.250.10
serverb     IN A 172.25.250.11

# 创建IPv4反向解析文件，可以参考/var/named/named.loopback
[root@servera ~]# cp /var/named/lab.example.com.zone /var/named/172.25.250.zone
[root@serverb ~]# vim /var/named/172.25.250.zone
$TTL 1D
@ IN SOA servera.lab.example.com. laoma.lab.example.com. (
     20210830 ; serial
     1D ; refresh
     1H ; retry
     1W ; expire
     3H ) ; minimum
; owner TTL CL type RDATA
            IN NS servera.lab.example.com.
10          IN PTR servera.lab.example.com.
11          IN PTR serverb.lab.example.com.

[root@servera ~]# chmod 640 /var/named/*.zone
[root@servera ~]# chgrp named /var/named/*.zone

# 启用并启动服务，设置防火墙
[root@servera ~]# systemctl enable named --now
[root@servera ~]# firewall-cmd --add-service=dns
[root@servera ~]# firewall-cmd --add-service=dns --permanent 
```

 

**测试**

```
[root@serverb ~]# dig @servera.lab.example.com serverb.lab.example.com
[root@serverb ~]# dig @servera.lab.example.com -x 172.25.250.11
```

 

### 5. 通过SMB共享目录

在`servera`上配置SMB服务：

-   您的SMB服务器必须是`STAFF`工作组的一个成员
-   共享`/common`目录共享名必须为`common`
-   只有`lab.example.com`域内的客户端可以访问common共享
-   `common`必须是可以浏览的
-   用户`rob`必须能够读取共享中的内容，如果需要的话，验证的密码是`redhat`
-   要求`rob` 用户以只读的方式访问该目录，`brian` 可以用读写的方式来访问该目录，brian密码为`redhat`

 

**准备工作**

```shell
[root@servera ~]# useradd rob
[root@servera ~]# useradd brian

[root@serverb ~]# useradd rob
[root@serverb ~]# useradd brian
```

 

**答题**

```shell
# 安装软件包
[root@servera ~]# yum install -y samba samba-client

# 查看uid，客户端用户uid与服务端用户uid保持一致
[root@servera ~]# id rob
uid=1002(rob) gid=1002(rob) groups=1002(rob)
[root@servera ~]# id brian
uid=1003(brian) gid=1003(brian) groups=1003(brian)

# samba用户不需要登录，设置用户shell
[root@servera ~]# usermod -s /sbin/nologin rob
[root@servera ~]# usermod -s /sbin/nologin brian

# 添加用户密码
[root@servera ~]# smbpasswd -a rob
New SMB password:`redhat`
Retype new SMB password:`redhat`
Added user rob.

[root@servera ~]# smbpasswd -a brian
New SMB password:`redhat`
Retype new SMB password:`redhat`
Added user brian.

[root@servera ~]# pdbedit -L
rob:1002:
brian:1003:

# 准备共享目录
[root@servera ~]# mkdir /common
[root@servera ~]# chgrp brian /common
[root@servera ~]# chmod 2775 /common

# label参考文件/etc/samba/smb.conf.example
# 正则表达式格式参考命令 semanage fcontext -l
[root@servera ~]# semanage fcontext -a -t samba_share_t "/common(/.*)?"
[root@servera ~]# restorecon -Rv /common

# 准备配置文件
[root@servera ~]# vim /etc/samba/smb.conf
# global中修改以下三个参数
[global]
        workgroup = STAFF
        # 以下两参考man smb.conf
        smb encrypt = required
        server min protocol = SMB3

# 添加common共享
[common]
        path = /common
        browseable = Yes
        hosts allow = 127. 172.25.250.
        write list = @brian

# 测试语法
[root@servera ~]# testparm
[root@servera ~]# echo $?
0

# 启用并启动服务
[root@servera ~]# systemctl enable --now smb nmb

# 配置防火墙
[root@servera ~]# firewall-cmd --add-service=samba
[root@servera ~]# firewall-cmd --add-service=samba --permanent
```

 

### 6. Samba 多用户

在`serverb` 上，要求通过smb 多用户的方式将共享目录`common` 挂载到`/mnt/private`上

-   要求在对该共享目录挂载时，以`rob` 的身份进行操作
-   要求每次开机该共享目录可以自动挂载

 

**答题**

```shell
# 验证用户rob和brian的uid是否与服务器一致，如果不一致使用usermod命令更改
[root@serverb ~]# id rob
uid=1002(rob) gid=1002(rob) groups=1002(rob)
[root@serverb ~]# id brian
uid=1003(brian) gid=1003(brian) groups=1003(brian)

[root@serverb ~]# yum install -y cifs-utils samba-client

# 查看共享
[root@serverb ~]# smbclient -L //servera -U rob%redhat

    Sharename       Type      Comment
    ---------       ----      -------
    print$          Disk      Printer Drivers
    common          Disk      
    IPC$            IPC       IPC Service (Samba 4.10.4)
    rob             Disk      Home Directories
......

# 查找挂载选项和格式
[root@serverb ~]# man mount.cifs

# 准备凭据文件
[root@serverb ~]# vim /etc/samba/creds.txt
username=rob
password=redhat
[root@serverb ~]# chmod 600 /etc/samba/creds.txt

# 配置永久挂载/etc/fstab
[root@serverb ~]# mkdir /mnt/private
[root@serverb ~]# cp /etc/fstab /etc/fstab.bak1
[root@serverb ~]# vim /etc/fstab
# 最后一行添加
//servera/common /mnt/private cifs credentials=/etc/samba/creds.txt,multiuser,seal 0 0
[root@serverb ~]# mount -a
[root@serverb ~]# df /mnt/private/
Filesystem       1K-blocks    Used Available Use% Mounted on
//servera/common  10474476 2316180   8158296  23% /mnt/private
```

 

**测试**

```shell
# 验证brian用户权限
[root@serverb ~]# su - brian
[brian@serverb ~]$ cifscreds add servera.lab.example.com
Password: redhat
[brian@serverb ~]$ echo brian > /mnt/private/brian
[brian@serverb ~]$ cat /mnt/private/brian
brian
[brian@serverb ~]$ exit
logout

# 验证rob用户权限
[root@serverb ~]# su - rob
[rob@serverb ~]$ ls /mnt/private/
brian
[rob@serverb ~]$ cifscreds add servera.lab.example.com
Password: 
[rob@serverb ~]$ ls /mnt/private/
brian
[rob@serverb ~]$ echo rob > /mnt/private/rob
-bash: /mnt/private/rob: Permission denied
[rob@serverb ~]$ exit
logout
```

 

### 7. 配置NFS服务

在`servera`配置NFS服务，要求如下：

-   以只读的方式共享目录`/public`同时只能被`lab.example.com`域中的系统访问
-   以读写的方式共享目录`/protected`能被`lab.example.com`域中的系统访问
-   目录`/protected`应该包含名为`project`拥有人为`student`的子目录
-   用户`student`能以读写方式访问`/protected/project`

 

**答题**

```shell
# 安装软件包
[root@servera ~]# yum install -y nfs-utils

# 准备共享目录
[root@servera ~]# mkdir -p /public /protected/project
[root@servera ~]# chown student /protected/project

# 配置导出规则
[root@servera ~]# man exports
[root@servera ~]# vim /etc/exports
/public *.example.com(ro)
/protected *.example.com(rw)

# 启用并启动服务，设置防火墙
[root@servera ~]# systemctl enable --now nfs-server
[root@servera ~]# firewall-cmd --add-service=nfs --add-service=mountd --add-service=rpc-bind
[root@servera ~]# firewall-cmd --add-service=nfs --add-service=mountd --add-service=rpc-bind --permanent 
```

 

### 8. 挂载NFS共享

在`serverb`上挂载一个来自`servera`的NFS共享，并符合下列要求：

-   `/public`挂载在下面的目录上`/mnt/nfsmount`
-   `/protected`挂载在下面的目录上`/mnt/nfssecure`
-   用户`student`能够在`/mnt/nfssecure/project`上创建文件
-   这些文件系统在系统启动时自动挂载

 

**答题**

```shell
# 查看服务端共享
[root@serverb ~]# showmount -e servera
Export list for servera:
/protected *.example.com
/public    *.example.com

# 配置永久挂载
[root@serverb ~]# mkdir /mnt/nfs{mount,secure}
[root@serverb ~]# cp /etc/fstab /etc/fstab.bak2
[root@serverb ~]# vim /etc/fstab
# 最后增加两条记录
servera:/public /mnt/nfsmount nfs ro 0 0
servera:/protected /mnt/nfssecure nfs rw 0 0

[root@serverb ~]# mount -a
[root@serverb ~]# df /mnt/nfsmount/ /mnt/nfssecure/
Filesystem         1K-blocks    Used Available Use% Mounted on
servera:/public     10474496 2323456   8151040  23% /mnt/nfsmount
servera:/protected  10474496 2323456   8151040  23% /mnt/nfssecure
```

 

**测试**

```shell
[root@serverb ~]# su - student -c "touch /mnt/nfsmount/stu-file.txt"
touch: cannot touch '/mnt/nfsmount/stu-file.txt': Read-only file system
[root@serverb ~]# su - student -c "touch /mnt/nfssecure/project/stu-file.txt"
```

 

### 9. 配置iSCSI服务端

配置`servera`提供一个iSCSI服务，磁盘名为`iqn.2014-11.com.example:servera`，并符合下列要求：

-   服务端口为`3260`
-   使用`iscsi_store`作其后端卷 其大小为`3G` 
-   此服务只能被`serverb.lab.example.com`访问

 

**答题**

```shell
# 查找未使用磁盘
[root@servera ~]# lsblk
NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda    252:0    0  10G  0 disk 
└─vda1 252:1    0  10G  0 part /
vdb    252:16   0   5G  0 disk 

# 准备后端卷iscsi_store
[root@servera ~]# vgcreate iscsi_store /dev/vdb
[root@servera ~]# lvcreate -L 3G -n iscsi_store iscsi_store

# 安装软件包
[root@servera ~]# yum install -y targetcli

# 启用并启动服务，设置防火墙
[root@servera ~]# systemctl enable target.service --now
[root@servera ~]# firewall-cmd --add-service=iscsi-target 
[root@servera ~]# firewall-cmd --add-service=iscsi-target --permanent

# 配置target
[root@servera ~]# targetcli 
Warning: Could not load preferences file /root/.targetcli/prefs.bin.
targetcli shell version 2.1.fb49
Copyright 2011-2013 by Datera, Inc and others.
For help on commands, type 'help'.

# 创建backstore
/> /backstores/block create iscsi_store /dev/iscsi_store/iscsi_store 
Created block storage object iscsi_store using /dev/iscsi_store/iscsi_store.

# 创建Target
/> /iscsi create iqn.2014-11.com.example:servera
Created target iqn.2014-11.com.example:servera.
Created TPG 1.
Global pref auto_add_default_portal=true
Created default portal listening on all IPs (0.0.0.0), port 3260.

# 配置Target中luns
/> /iscsi/iqn.2014-11.com.example:servera/tpg1/luns create /backstores/block/iscsi_store 
Created LUN 0.

# 配置Target中acls
/> /iscsi/iqn.2014-11.com.example:servera/tpg1/acls create iqn.2014-06.com.example:serverb
Created Node ACL for iqn.2014-06.com.example:serverb
Created mapped LUN 0.

# 配置Target中portals
/> /iscsi/iqn.2014-11.com.example:servera/tpg1/portals/ delete 0.0.0.0 3260
Deleted network portal 0.0.0.0:3260
/> /iscsi/iqn.2014-11.com.example:servera/tpg1/portals/ create 172.25.250.10 3260
Using default IP port 3260
Created network portal 172.25.250.10:3260.

# 保存配置
/> saveconfig 
Configuration saved to /etc/target/saveconfig.json

# 查看配置
/> ls
o- / .............................................................................. [...]
  o- backstores ................................................................... [...]
  | o- block ....................................................... [Storage Objects: 1]
  | | o- iscsi_store ....... [/dev/iscsi_store/iscsi_store (3.0GiB) write-thru activated]
  | |   o- alua ........................................................ [ALUA Groups: 1]
  | |     o- default_tg_pt_gp ............................ [ALUA state: Active/optimized]
  | o- fileio ...................................................... [Storage Objects: 0]
  | o- pscsi ....................................................... [Storage Objects: 0]
  | o- ramdisk ..................................................... [Storage Objects: 0]
  o- iscsi ................................................................. [Targets: 1]
  | o- iqn.2014-11.com.example:servera ........................................ [TPGs: 1]
  |   o- tpg1 .................................................... [no-gen-acls, no-auth]
  |     o- acls ............................................................... [ACLs: 1]
  |     | o- iqn.2014-06.com.example:serverb ........................... [Mapped LUNs: 1]
  |     |   o- mapped_lun0 ................................ [lun0 block/iscsi_store (rw)]
  |     o- luns ............................................................... [LUNs: 1]
  |     | o- lun0 . [block/iscsi_store (/dev/iscsi_store/iscsi_store) (default_tg_pt_gp)]
  |     o- portals ......................................................... [Portals: 1]
  |       o- 172.25.250.10:3260 .................................................... [OK]
  o- loopback .............................................................. [Targets: 0]
/> exit
Global pref auto_save_on_exit=true
Configuration saved to /etc/target/saveconfig.json
```

 

### 10. 配置iSCSI的客户端

配置`serverb`使其能连接servera提供的`iqn.2014-11.com.example:servera`，并符合以下要求：

-   iSCSI设备在系统启动的期间自动加载
-   块设备iSCSI上包含一个大小为`2100MiB`的分区，并格式化为`ext4`
-   此分区挂载在`/mnt/data`上，同时在系统启动的期间自动挂载

 

**答题**

```shell
# 安装软件包
[root@serverb ~]# yum install -y iscsi-initiator-utils

# 配置InitiatorName为服务端放行的InitiatorName
[root@serverb ~]# vim /etc/iscsi/initiatorname.iscsi
InitiatorName=iqn.2014-06.com.example:serverb

# 启用并启动服务
[root@serverb ~]# systemctl enable iscsi --now
# iscsi服务要确保开机启动，用于发现并登录目标。
[root@serverb ~]# systemctl enable iscsid --now

# iscsi服务：Login and scanning of iSCSI device，客户端使用
# iscsid服务：用于接收客户端请求，服务端使用。但课后练习中启用了iscsid。
# 实际情况，这两个服务都不启动也可以正常运行。

# 帮助信息参考
[root@serverb ~]# man iscsiadm

# 发现Target
[root@serverb ~]# iscsiadm -m discovery -t st -p servera
172.25.250.10:3260,1 iqn.2014-11.com.example:servera

# 登录Target
[root@serverb ~]# iscsiadm -m node -T iqn.2014-11.com.example:servera -l
Logging in to [iface: default, target: iqn.2014-11.com.example:servera, portal: 172.25.250.10,3260]
Login to [iface: default, target: iqn.2014-11.com.example:servera, portal: 172.25.250.10,3260] successful.

# 创建分区
[root@serverb ~]# lsblk
NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sda      8:0    0   3G  0 disk 
vda    252:0    0  10G  0 disk 
└─vda1 252:1    0  10G  0 part /
vdb    252:16   0   5G  0 disk

[root@serverb ~]# fdisk /dev/sda

Welcome to fdisk (util-linux 2.32.1).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): `n`
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): `回车`

Using default response p.
Partition number (1-4, default 1): `回车
First sector (2048-6291455, default 2048): `回车`
Last sector, +sectors or +size{K,M,G,T,P} (2048-6291455, default 6291455): ``+2100M`

Created a new partition 1 of type 'Linux' and of size 2.1 GiB.

Command (m for help): `w`
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.

# 格式化并持久化挂载
[root@serverb ~]# mkfs.ext4 /dev/sda1
[root@serverb ~]# blkid /dev/sda1
/dev/sda1: UUID="9a56ee54-37ec-48c7-929e-e97ea0a57de4" TYPE="ext4" PARTUUID="886e1046-01"
[root@serverb ~]# mkdir /mnt/data
[root@serverb ~]# cp /etc/fstab /etc/fstab.bak3
[root@serverb ~]# vim /etc/fstab
# 最后一行添加如下记录，注意挂载选项_netdev
UUID="9a56ee54-37ec-48c7-929e-e97ea0a57de4" /mnt/data ext4 _netdev 0 0

[root@serverb ~]# mount -a
[root@serverb ~]# df -hT /mnt/data
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda1      ext4  2.0G  6.2M  1.9G   1% /mnt/data
```

如果InitiatorName配置错误，导致登录失败，此时即使InitiatorName改为正确的配置也无法登录。

纠正流程如下：

```shell
#-1- InitiatorName改为正确的值。
#-2- 删除/var/lib/iscsi/nodes/目录下iqn.2014-11.com.example:servera
[root@serverb ~]# ls /var/lib/iscsi/nodes/
iqn.2014-11.com.example:servera
[root@serverb ~]# rm -fr /var/lib/iscsi/nodes/iqn.2014-11.com.example\:servera/
#-3- 重新发现
#-4- 重新登录
```

 

### 11. 搭建MariaDB

在`servera`上配置一个数据库服务器，然后执行下述步骤：

-   仅`localhost` 登录。使用帐户`root`。密码`redhat`
-   将http://materials.example.com/classroom/database-working/inventory.dump文件下载，并恢复`contacts` 库
-   按以下要求设置数据库访问用户 用户名 `mary`，密码 `mary_password`，对 contacts 数据库所有数据有`选择`权限

 

**答题**

```shell
# 安装软件包
[root@servera ~]# yum install -y mariadb-server

# 配置mariadb-server只监听本地
[root@servera ~]# vim /etc/my.cnf.d/mariadb-server.cnf
# 在mysqld块中添加一行skip-networing=1，其他保持不变
[mysqld]
skip-networking=1

# 启用并启动服务，配置防火墙
[root@servera ~]# systemctl enable mariadb --now
[root@servera ~]# firewall-cmd --add-service=mysql
[root@servera ~]# firewall-cmd --add-service=mysql --permanent 

# 安全初始化mariadb
[root@servera ~]# mysql_secure_installation 

NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!

In order to log into MariaDB to secure it, we'll need the current
password for the root user.  If you've just installed MariaDB, and
you haven't set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none): `回车`
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MariaDB
root user without the proper authorisation.

Set root password? [Y/n] `回车`
New password: `redhat`
Re-enter new password: `redhat`
Password updated successfully!
Reloading privilege tables..
 ... Success!


By default, a MariaDB installation has an anonymous user, allowing anyone
to log into MariaDB without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] `回车`
 ... Success!

Normally, root should only be allowed to connect from 'localhost'.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] `回车`
 ... Success!

By default, MariaDB comes with a database named 'test' that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] `回车`
 - Dropping test database...
 ... Success!
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] `回车`
 ... Success!

Cleaning up...

All done!  If you've completed all of the above steps, your MariaDB
installation should now be secure.

Thanks for using MariaDB!

# 登录数据库
[root@servera ~]# mysql -u root -predhat
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 20
Server version: 10.3.17-MariaDB MariaDB Server

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

# 帮助信息
MariaDB [(none)]> help show;
Name: 'SHOW'
Description:
SHOW has many forms that provide information about databases, tables,
columns, or status information about the server. This section describes
those following:

SHOW AUTHORS
SHOW {BINARY | MASTER} LOGS
SHOW BINLOG EVENTS [IN 'log_name'] [FROM pos] [LIMIT [offset,] row_count]
SHOW CHARACTER SET [like_or_where]
SHOW COLLATION [like_or_where]
SHOW [FULL] COLUMNS FROM tbl_name [FROM db_name] [like_or_where]
......

# 创建空数据库，用于恢复
MariaDB [(none)]> SHOW databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
3 rows in set (0.001 sec)

MariaDB [(none)]> CREATE database contacts;
Query OK, 1 row affected (0.001 sec)

MariaDB [(none)]> exit
Bye

# 恢复数据库
[root@servera ~]# wget http://materials.example.com/classroom/database-working/inventory.dump
[root@servera ~]# mysql -u root -predhat contacts < inventory.dump

# 配置用户
[root@servera ~]# mysql -u root -predhat

MariaDB [(none)]> CREATE USER 'mary'@'localhost' IDENTIFIED BY 'mary_password';
Query OK, 0 rows affected (0.001 sec)

MariaDB [(none)]> GRANT SELECT ON contacts.* TO 'mary'@'localhost';
Query OK, 0 rows affected (0.001 sec)

# `FLUSH PRIVILEGES`语句不执行也可以。
MariaDB [(none)]> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.003 sec)

MariaDB [(none)]> exit
Bye
```

 

### 12. 数据查询填空1

完成以下要求的查询并将结果填入相应的框格中。

-   查询`RT-AC68U`产品的供应商名称为**__****__****__****__****__**

 

**答题**

```shell
[root@servera ~]# mysql -u mary -pmary_password contacts

# 获取产品RT-AC68U是由供应商id为3的供应商提供
MariaDB [contacts]> SELECT * FROM product;
+----+-------------------+---------+-------+-------------+-----------------+
| id | name              | price   | stock | id_category | id_manufacturer |
+----+-------------------+---------+-------+-------------+-----------------+
|  1 | ThinkServer TS140 |  539.88 |    20 |           2 |               4 |
|  2 | ThinkServer RD630 | 2379.14 |    20 |           2 |               4 |
|  3 | RT-AC68U          |  219.99 |    10 |           1 |               3 |
|  4 | X110 64GB         |   73.84 |   100 |           3 |               1 |
+----+-------------------+---------+-------+-------------+-----------------+
4 rows in set (0.001 sec)

# 查询供应商id为3的供应商是Asus
MariaDB [contacts]> SELECT * FROM manufacturer;
+----+----------+----------------+-------------------+
| id | name     | seller         | phone_number      |
+----+----------+----------------+-------------------+
|  1 | SanDisk  | John Miller    | +1 (941) 329-8855 |
|  2 | Kingston | Mike Taylor    | +1 (341) 375-9999 |
|  3 | Asus     | Wilson Jackson | +1 (432) 367-8899 |
|  4 | Lenovo   | Allen Scott    | +1 (876) 213-4439 |
+----+----------+----------------+-------------------+
4 rows in set (0.000 sec)

# 如果供应商记录非常多，使用where子句限定id
MariaDB [contacts]> SELECT * FROM manufacturer where id=3;
+----+------+----------------+-------------------+
| id | name | seller         | phone_number      |
+----+------+----------------+-------------------+
|  3 | Asus | Wilson Jackson | +1 (432) 367-8899 |
+----+------+----------------+-------------------+
1 row in set (0.003 sec)

# 还可以使用以下语句一次性搞定。
MariaDB [contacts]>  SELECT manufacturer.name FROM manufacturer,product
    -> WHERE manufacturer.id=product.id_manufacturer
    -> AND product.name='RT-AC68U';
+------+
| name |
+------+
| Asus |
+------+
1 row in set (0.001 sec)
```

 

### 13. 数据查询填空2

完成以下要求的查询并将结果填入相应的框格中。

-   查询类型是`Servers`，且供应商是`Lenovo`的产品有多少**__****__****__****__****__**

 

**答题**

```shell
# 根据上一题得出结论，产品的数量由表product中stock属性提供。
# product表提供了id_category和id_manufacturer，没有提供对应的名称。

# 先根据名称查询对应id
MariaDB [contacts]> SELECT * FROM manufacturer where name='Lenovo';
+----+--------+-------------+-------------------+
| id | name   | seller      | phone_number      |
+----+--------+-------------+-------------------+
|  4 | Lenovo | Allen Scott | +1 (876) 213-4439 |
+----+--------+-------------+-------------------+
1 row in set (0.001 sec)

MariaDB [contacts]> SELECT * FROM category WHERE name='Servers';
+----+---------+
| id | name    |
+----+---------+
|  2 | Servers |
+----+---------+
1 row in set (0.000 sec)

# 查询产品数量
MariaDB [contacts]> SELECT * FROM product where id_category=2 AND id_manufacturer=4;
+----+-------------------+---------+-------+-------------+-----------------+
| id | name              | price   | stock | id_category | id_manufacturer |
+----+-------------------+---------+-------+-------------+-----------------+
|  1 | ThinkServer TS140 |  539.88 |    20 |           2 |               4 |
|  2 | ThinkServer RD630 | 2379.14 |    20 |           2 |               4 |
+----+-------------------+---------+-------+-------------+-----------------+
2 rows in set (0.001 sec)

# 如果记录比较多，可以使用sum函数计算
MariaDB [contacts]> SELECT sum(stock) FROM product where id_category=2 AND id_manufacturer=4;
+------------+
| sum(stock) |
+------------+
|         40 |
+------------+
1 row in set (0.003 sec)

# 还可以使用以下语句一次性搞定
MariaDB [contacts]> SELECT sum(stock) 
    -> FROM category, manufacturer, product
    -> WHERE category.id=product.id_category
    -> AND manufacturer.id=product.id_manufacturer
    -> AND category.name="Servers"
    -> AND manufacturer.name="Lenovo";
+------------+
| sum(stock) |
+------------+
|         40 |
+------------+
1 row in set (0.001 sec)
```

>   考试时候，有可能是查询人的信息：住在哪里（华盛顿），名称是什么（tom）。
>
>   名称是指firstname，看英文题目。

 

### 14. 实现一个web服务器

在`servera`上配置一个站点http://www0.lab.example.com然后执行下述步骤：

-   从http://materials.example.com/laoma/www0.html下载文件
-   并且将文件重命名为`index.html`不要修改此文件的内容
-   将文件`index.html`拷贝到您的web服务器的`DocumentRoot`目录下
-   来自于`lab.example.com`域的客户端可以访问此web服务
-   来自于`lab.example.org`域的客户端拒绝访问此Web服务

 

**准备工作**

```shell
[root@bastion ~]# cat << EOF > /etc/dnsmasq.d/cname.conf
cname=www0.lab.example.com,servera.lab.example.com
cname=www0,servera.lab.example.com
cname=webapp0.lab.example.com,servera.lab.example.com
cname=webapp0,servera.lab.example.com
EOF
[root@bastion ~]# systemctl restart dnsmasq

[root@foundation0 ~]# mkdir /content/courses/rh358/rhel8.1/materials/laoma
[root@foundation0 ~]# cd /content/courses/rh358/rhel8.1/materials/laoma
[root@foundation0 laoma]# echo www0 > www0.html
[root@foundation0 laoma]# echo webapp0 > webapp0.html
[root@foundation0 laoma]# echo permission > permission.html
[root@foundation0 laoma]# sed -i '/servera/s/$/ www0.lab.example.com webapp0.lab.example.com/' /etc/hosts
```

 

**答题**

```shell
# 安装软件包
[root@servera ~]# yum install -y httpd

# 准备站点主页
[root@servera ~]# wget http://materials.example.com/laoma/www0.html -O /var/www/html/index.html
[root@servera ~]# cat /var/www/html/index.html 
www0

# 准备配置文件
[root@servera ~]# rpm -qd httpd |grep vhost
/usr/share/doc/httpd/httpd-vhosts.conf
[root@servera ~]# cp /usr/share/doc/httpd/httpd-vhosts.conf /etc/httpd/conf.d/vhost-www0.conf
[root@servera ~]# vim /etc/httpd/conf.d/vhost-www0.conf
<VirtualHost *:80>
    DocumentRoot "/var/www/html"
    ServerName www0.lab.example.com
    <Directory /var/www/html>
        Require host lab.example.com
        Require all denied
    </Directory>
</VirtualHost>

# 启用并启动服务，配置防火墙
[root@servera ~]# systemctl enable httpd --now
[root@servera ~]# firewall-cmd --add-service=http 
[root@servera ~]# firewall-cmd --add-service=http --permanent
```

 

**测试**

```shell
[root@serverb ~]# curl http://www0.lab.example.com
www0

# foundation0属于域ilt.example.com
[kiosk@foundation0 ~]$ hostname
foundation0.ilt.example.com
[kiosk@foundation0 ~]$ curl http://www0.lab.example.com -s |head
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <title>Test Page for the Apache HTTP Server on Red Hat Enterprise Linux</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <style type="text/css">
            /*<![CDATA[*/
            body {
                background-color: #fff;
```

 

### 15. 配置安全web服务

站点http://www0.lab.example.com配置TLS加密

-   一个已签名证书从http://materials.example.com/laoma/www0.lab.example.com.crt获取
-   此证书的密钥从http://materials.example.com/laoma/www0.lab.example.com.key获取
-   此证书的签名授权信息从http://materials.example.com/laoma/example-ca.crt获取

 

**准备工作**

```shell
[root@foundation0 ~]# cd /content/courses/rh358/rhel8.1/materials/laoma
[root@foundation0 laoma]# openssl genrsa -out www0.lab.example.com.key 2048
[root@foundation0 laoma]# openssl req -new -key www0.lab.example.com.key -out www0.lab.example.com.csr -subj "/C=CN/ST=JS/L=NJ/O=LM/OU=DEVOPS/CN=www0.lab.example.com/emailAddress=laoma@lab.example.com"
[root@foundation0 laoma]# openssl genrsa -out example-ca.key 2048
[root@foundation0 laoma]# openssl req -new -x509 -days 3650 -key example-ca.key -out example-ca.crt -subj "/C=CN/ST=JS/L=NJ/O=LM/OU=DEVOPS/CN=ca.example.com/emailAddress=laoma@lab.example.com"
[root@foundation0 laoma]# openssl x509 -req -days 3650 -in www0.lab.example.com.csr -CA example-ca.crt -CAkey example-ca.key -set_serial 01 -out www0.lab.example.com.crt
[root@foundation0 laoma]# chmod 644 www0.lab.example.com.key
```

 

**答题**

```shell
# 安装软件包
[root@servera ~]# yum install -y mod_ssl

# 准备配置文件
[root@servera ~]# cp /etc/httpd/conf.d/ssl.conf /etc/httpd/conf.d/vhost-www0-ssl.conf
[root@servera ~]# vim /etc/httpd/conf.d/vhost-www0-ssl.conf
<VirtualHost _default_:443> 
    ServerName www0.lab.example.com 
    DocumentRoot /var/www/html
    SSLEngine on 
    SSLprotocol all -SSLv2 -SSLv3 
    SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5 
    SSLHonorCipherOrder on
    SSLCertificateFile /etc/pki/tls/certs/www0.lab.example.com.crt
    SSLCertificateKeyFile /etc/pki/tls/private/www0.lab.example.com.key 
    SSLCertificateChainFile /etc/pki/tls/certs/example-ca.crt 
</VirtualHost> 

# 准备证书
[root@servera ~]# wget http://materials.example.com/laoma/www0.lab.example.com.crt -P /etc/pki/tls/certs/
[root@servera ~]# wget http://materials.example.com/laoma/www0.lab.example.com.key -P /etc/pki/tls/private/
[root@servera ~]# wget http://materials.example.com/laoma/example-ca.crt -P /etc/pki/tls/certs/

# 重启服务，配置防火墙
[root@servera ~]# systemctl restart httpd
[root@servera ~]# firewall-cmd --add-service=https 
[root@servera ~]# firewall-cmd --add-service=https --permanent
```

 

**测试**

```shell
[root@serverb ~]# curl https://www0.lab.example.com -k
www0
```

 

### 16. 配置虚拟主机

在`servera`上扩展您的web服务器，为站点http://webapp0.lab.example.com创建一个虚拟主机，然后执行下述步骤：

-   设置DocumentRoot为`/var/www/virtual`
-   从http://materials.example.com/laoma/webapp0.html下载文件
-   并重命名为`index.html`不要对文件index.html的内容做任何修改
-   将文件index.html放到虚拟机的DocumentRoot目录下，确保`floyd`用户能够在/var/www/virtual目录下创建文件

>   注意：原始站点http://www0.lab.example.com必须仍然能够访问
>
>   名称服务器 bastion.lab.example.com 提供对主机名 webapp0.lab.exmple.com 的域名解析

 

**准备工作**

```shell
[root@servera ~]# useradd floyd
```

 

**答题**

```shell
# 准备站点主页
[root@servera ~]# mkdir /var/www/virtual
[root@servera ~]# wget http://materials.example.com/laoma/webapp0.html -O /var/www/virtual/index.html
[root@servera ~]# cat /var/www/virtual/index.html
webapp0

# 准备配置文件
[root@servera ~]# chown floyd /var/www/virtual
[root@servera ~]# cp /etc/httpd/conf.d/vhost-www0.conf /etc/httpd/conf.d/vhost-webapp0.conf
[root@servera ~]# vim /etc/httpd/conf.d/vhost-webapp0.conf
<VirtualHost *:80>
    DocumentRoot "/var/www/virtual"
    ServerName webapp0.lab.example.com
    <Directory /var/www/virtual>
        Require all granted
    </Directory>
</VirtualHost>

# 重启服务
[root@servera ~]# systemctl restart httpd
```

 

**测试**

```
[root@serverb ~]# curl http://webapp0.lab.example.com
webapp0
```

 

### 17. 配置web内容的访问

在您的`servera`上的web服务器的DocumentRoot目录下创建一个名为`private`的目录，要求如下：

-   从http://materials.example.com/laoma/permission.html下载一个文件副本到这个目录，并且重命名为`index.html`
-   不要对这个文件的内容做任何修改
-   从 `servera` 上，任何人都可以浏览`private`的内容，但是从其它系统不能访问这个目录的内容

>   以前考试评分，是针对站点www0.lab.example.com，建议第二个站点webapp0.lab.example.com也配置。

 

**答题**

```
# 准备站点主页
[root@servera ~]# mkdir /var/www/{virtual,html}/private
[root@servera ~]# wget http://materials.example.com/laoma/permission.html -O /var/www/html/private/index.html
[root@servera ~]# wget http://materials.example.com/laoma/permission.html -O /var/www/virtual/private/index.html

# 准备配置文件
[root@servera ~]# vim /etc/httpd/conf.d/vhost-www0.conf
<VirtualHost *:80>
    DocumentRoot "/var/www/html"
    ServerName www0.lab.example.com
    <Directory /var/www/html>
        Require host lab.example.com
        Require all denied
    </Directory>

# 添加/var/www/www0/private设定
    <Directory /var/www/html/private>
        Require local
        Require all denied
    </Directory>

</VirtualHost>

[root@servera ~]# vim /etc/httpd/conf.d/vhost-webapp0.conf
<VirtualHost *:80>
    DocumentRoot "/var/www/virtual"
    ServerName webapp0.lab.example.com
    <Directory /var/www/virtual>
        Require all granted
    </Directory>

# 添加/var/www/www0/private设定
    <Directory /var/www/virtual/private>
        Require local
        Require all denied
    </Directory>

</VirtualHost>
```

 

**测试**

```
[root@serverb ~]# curl http://www0.lab.example.com/private/index.html
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>403 Forbidden</title>
</head><body>
<h1>Forbidden</h1>
<p>You don't have permission to access /private/index.html
on this server.<br />
</p>
</body></html>

[root@servera ~]# curl http://www0.lab.example.com/private/index.html
permission
```

 

### 18. 通过 ansible 布署 Nginx

在`serverc`和`serverd`上配置一个站点，然后执行下述步骤：

-   在`playbooks`目录下创建剧本`nginx.yml`
-   从http://materials.example.com/laoma/nginx.conf.j2下载jinja模板文件
-   从http://materials.example.com/laoma/nginx.html下载文件，并且将文件重命名为`index.html`，不要修改此文件的内容
-   将文件`index.html`拷贝到您的web服务器的`DocumentRoot`目录下

 

**准备工作**

```
[root@foundation0 ~]# cd /content/courses/rh358/rhel8.1/materials/laoma
[root@foundation0 laoma]# echo nginx > nginx.html
[root@foundation0 laoma]# cat <<'EOF' > nginx.conf.j2
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
include /usr/share/nginx/modules/*.conf;
events {
    worker_connections 1024;
}
http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;
    include /etc/nginx/conf.d/*.conf;
    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  {{ ansible_fqdn }};
        root         /usr/share/nginx/html;
        include /etc/nginx/default.d/*.conf;
        location / {
        }
        error_page 404 /404.html;
            location = /40x.html {
        }
        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }
}
EOF

[root@serverd ~]# systemctl stop httpd
```

 

**答题**

```
# 设置vim，便于编辑Playbook
[student@workstation ~]$ vim ~/.vimrc
set ai ts=2

# 准备ansible项目目录
[student@workstation ~]$ mkdir playbooks
[student@workstation ~]$ cd playbooks/
[student@workstation playbooks]$ vim inventory
serverc
serverd

[student@workstation playbooks]$ vim ansible.cfg
[defaults]
inventory=inventory
remote_user=root
# 如果无法使用root就配置提权
#[privilege_escalation]
#become=True

# 测试基础配置
[student@workstation playbooks]$ ansible serverc,serverd -m ping

# 下载模版
[student@workstation playbooks]$ wget http://materials.example.com/laoma/nginx.conf.j2

# 准备剧本
[student@workstation playbooks]$ vim nginx.yml
---
- name: deploy nginx
  hosts: serverc,serverd
  tasks:
    - name: install nginx
      yum:
        name: nginx
        state: present
    - name: template nginx.conf.j2
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
    - name: enable and start nginx
      service:
        name: nginx
        state: started
        enabled: yes 
    - name: prepare index.html
      get_url:
        url: http://materials.example.com/laoma/nginx.html
        # 主目录路径参考nginx.conf.j2文件
        dest: /usr/share/nginx/html/index.html
    - name: set firewalld
      firewalld:
        service: http
        permanent: yes 
        immediate: yes 
        state: enabled
# 执行剧本
[student@workstation playbooks]$ ansible-playbook nginx.yml
```

**测试**

```
[student@workstation ~]$ curl http://serverc.lab.example.com
[student@workstation ~]$ curl http://serverd.lab.example.com
```

 

### 19. 通过 ansible 配置 firewall

在 `serverc` 和 `serverd` 上分别设置，针对SSH

-   在`playbooks`目录下创建剧本`firewall.yml`
-   允许`172.25.250.0/24` 的域对 serverc 和 serverd 进行`SSH` 
-   禁止`172.24.250.0/24` 的域对 serverc 和 serverd 进行`SSH` 

 

**答题**

```
# 准备剧本
[student@workstation playbooks]$ vim firewall.yml
---
- name: use firewall to secure ssh
  hosts: serverc, serverd
  tasks:
    - name: deny ssh
      firewalld:
        service: ssh
        permanent: yes
        immediate: yes
        state: disabled
    - name: allow ssh for 172.25.250.0/24
      firewalld:
        rich_rule: rule family="ipv4" source address="172.25.250.0/24" service name="ssh" accept
        permanent: yes
        immediate: yes
        state: enabled
    - name: deny ssh for172.24.250.0/24
      firewalld:
        rich_rule: rule family="ipv4" source address="172.24.250.0/24" service name="ssh" reject
        permanent: yes
        immediate: yes
        state: enabled
# 执行剧本
[student@workstation playbooks]$ ansible-playbook firewall.yml
```

 

**测试**

```
[student@workstation playbooks]$ ansible serverc,serverd -a 'firewall-cmd --list-all'
serverc | CHANGED | rc=0 >>
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0
  sources: 
  services: cockpit dhcpv6-client
  ports: 
  protocols: 
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich rules: 
    rule family="ipv4" source address="172.25.250.0/24" service name="ssh" accept
    rule family="ipv4" source address="172.24.250.0/24" service name="ssh" reject
...
```

 

### 20. 通过 ansible 配置空邮件客户端

在系统 `serverc` 和 `serverd` 上配置邮件服务，满足以下要求：

-   在`playbooks`目录下创建剧本创建剧本`nullclients.yml`
-   这些系统不能接收外部发送来的邮件
-   在这些系统上本地发送的任何邮件都会自动路由到`smtp.lab.example.com`
-   从这些系统上发送的邮件显示来自于`lab.example.com`
-   您可以通过发送邮件到本地用户`student`来测试您的配置，系统`smtp.lab.example.com` 已经配置
-   可以通过如下网址测试`http://bastion.lab.example.com/mail`

 

**准备工作**

```
# 该命令在考前准备步骤中已经执行过，这里阐述命令作用。
[student@workstation ~]$ lab smtp-automation start
# 配置bastion节点上DNS，SMTP，IMAP环境
```

**答题**

```
# 验证角色linux-system-roles.postfix是否存在
[student@workstation playbooks]$ ansible-galaxy list |grep postfix
- linux-system-roles.postfix, (unknown version)
- rhel-system-roles.postfix, (unknown version)
[WARNING]: - the configured path /home/student/.ansible/roles does not exist.

# 如果角色不存在，则安装软件包rhel-system-roles
[student@workstation playbooks]$ sudo yum install rhel-system-roles

# 查看角色README文件，获取角色使用说明
[student@workstation playbooks]$ rpm -qd rhel-system-roles|grep postfix
/usr/share/ansible/roles/rhel-system-roles.postfix/README.html
/usr/share/ansible/roles/rhel-system-roles.postfix/README.md
/usr/share/doc/rhel-system-roles/postfix/COPYING
/usr/share/doc/rhel-system-roles/postfix/README.html
/usr/share/doc/rhel-system-roles/postfix/README.md
[student@workstation playbooks]$ less /usr/share/doc/rhel-system-roles/postfix/README.md 
# 搜索 Example Playbook，获得剧本模版

# 为了获得postconf配置参数，在serverc安装postfix，角色本身会安装postfix
[root@serverc ~]# yum install -y postfix
[root@serverc ~]# less /usr/share/doc/postfix/README_FILES/STANDARD_CONFIGURATION_README
# 搜索关键字`null`查找对应参数

# mynetwork值使用以下命令获取
[root@serverc ~]# postconf |grep ^mynetwork
mynetworks = 127.0.0.1/32 [::1]/128
......

# 准备剧本
[student@workstation playbooks]$ vim nullclients.yml
---
- name: Configure Null Client Email Service
  hosts: serverc,serverd

  vars:
    postfix_conf:
      relayhost: "[smtp.lab.example.com]"
      inet_interfaces: "loopback-only"
      mynetworks: "127.0.0.0/8 [::1]/128"
      myorigin: "lab.example.com"
      mydestination: ""

  roles:
    - linux-system-roles.postfix
# 执行剧本
[student@workstation playbooks]$ ansible-playbook nullclients.yml
```

**测试**

```
# 发送测试
[student@serverc ~]$ mail -s 'serverc cull client' student
local student from serverc
.
EOT

# 读取邮件
[student@serverc ~]$ mutt -f imaps://imap.lab.example.com
Username at imap.lab.example.com: student
Password for student@imap.lab.example.com: student

# 为了实现从网页访问，执行以下操作
[root@bastion ~]# setenforce 0
[root@bastion ~]# ln -s /var/spool/mail /var/www/html/mail
[root@bastion ~]# chmod a+r /var/www/html/mail/student
```

 

### 21. 通过 ansible 布署打印机

在系统 `serverc` 和 `serverd` 上配置打印机，满足以下要求：

-   在`playbooks`目录下创建剧本`printer-create.yml`
-   安装打印机为默认打印机
-   printer queue `my-printer`
-   URI地址`ipp://serverc.lab.example.com:631/printers/rht-printer`

**准备工作**

```
# 该命令在考前准备步骤中已经执行过，这里阐述命令作用。
[student@workstation ~]$ lab printing-automation start
# 在serverc上配置一个IPP Everywhere打印机
# 通过http://serverd/ippserver/ipp-everywhere-pdf查看打印任务
```

为了实现题目要求，我们用servera代替这里的serverc和serverd

**答题**

```
# 准备剧本
[student@workstation playbooks]$ vim printer-create.yml 
---
- name: Install CUPS and create a print queue
  hosts: servera，serverb
  gather_facts: no

  tasks:
    - name: Install the CUPS and Avahi packages
      yum:
        name: cups,avahi
        state: present

    - name: Enable and start the CUPS and Avahi services
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop: 
        - avahi-daemon
        - cups

    - name: Open the mDNS firewall port
      firewalld:
        service: mdns
        state: enabled
        permanent: yes
        immediate: yes

    - name: Create the print queue
      # lpadmin命令参考man lpadmin
      command: lpadmin -p my-printer -v ipp://serverc.lab.example.com:631/printers/rht-printer -m everywhere -E

    - name: Make the new print queue the default
      command: lpadmin -d "{{ queue_name }}"
# 执行剧本
[student@workstation playbooks]$ ansible-playbook printer-create.yml
```

**测试**

```
[student@workstation playbooks]$ ansible servera -a 'lpstat -d ; lpstat -v'
servera | CHANGED | rc=0 >>
system default destination: my-printer
device for my-printer: ipp://serverc.lab.example.com:631/printers/rht-printer
```

 

## 考试要点

>   详情参考：[红帽认证服务管理和自动化专家考试](https://www.redhat.com/zh/services/training/ex358-red-hat-certified-specialist-services-management-automation-exam) 

除了以下所列目标外，参加红帽认证服务管理和自动化专家考试的考生还应参考红帽认证工程师考试（RHCE）的考试目标，并应能够胜任 RHCE 级别的任务，因为本考试可能要求考生掌握这些技能。

参加红帽认证服务管理和自动化专家考试的考生应能够独立完成下列任务。考生应能够手动和利用 Ansible 自动化执行这些任务。

-   **管理网络服务**
    -   `配置网络客户端，以使用`动态或`静态分配的地址`
    -   `使用 IPv4 和 IPv6 工作`
-   **管理防火墙服务**
    -   `配置系统防火墙，以允许访问特定的服务或端口`
    -   `配置系统防火墙，以仅允许或拒绝来自特定网域或 IP 子网的访问`
-   **管理 SELinux**
    -   配置指定服务的 SELinux 布尔值
    -   `配置文件或目录的 SELinux 上下文`
-   **管理系统进程**
    -   `将系统进程配置为在系统引导时启动`
    -   阻止系统进程启动
-   **管理链路聚合**
    -   创建由两个网络接口构成的网络组接口
    -   使网络组接口在系统重启后保持有效
    -   为网络组接口分配网络地址
    -   配置 teamd 运行程序
-   **管理 DNS**
    -   配置缓存名称服务器
    -   `利用部分完成的区域文件配置授权域名服务器`
    -   `配置 IPv4 和 IPv6 地址正向与反向查询`
-   **管理 DHCP**
    -   `配置指定地址范围内的地址分配`
    -   `将特定地址分配配置给指定的主机`
    -   `配置 IPv4` 和 IPv6 `地址分配`
-   **管理打印机**
    -   `创建和管理网络打印机的打印机队列`
    -   管理现有的打印机队列
-   **管理电子邮件服务**
    -   `配置电子邮件服务器，以将电子邮件转发到出站邮件中继`
    -   `使用邮件客户端读取或发送电子邮件`
-   **管理 MariaDB 数据库服务器**
    -   `安装和配置基本的 MariaDB 服务`
    -   `将 MariaDB 服务器访问限制到特定的网络地址`
    -   `创建 MariaDB 数据库`
    -   `管理 MariaDB 数据库用户和访问权限`
    -   添加记录到现有的 MariaDB 数据库
    -   `提交对 MariaDB 数据库的简单 SQL 查询`
    -   创建 MariaDB 备份
    -   `从备份导入 MariaDB 数据库`
-   **管理 HTTPD Web 访问**
    -   `安装和配置 Apache`
    -   `安装和配置 NGINX`
    -   `配置替代文档根目录`
    -   配置替代 Web 访问端口
    -   `配置基于名称的虚拟主机`
    -   `配置安全 Web 服务器（HTTPS）`
    -   提供静态缓存以缩短 HTTP 响应时间
    -   配置 HTTP HAProxy 负载平衡器
    -   终止 HTTPS 连接
-   **管理 iSCSI**
    -   `提供和配置 iSCSI 目标`
    -   `配置 iSCSI 启动器，以持久连接 iSCSI 目标`
    -   `将对 iSCSI 服务的访问限制到特定的客户端和访问`
-   **管理 NFS**
    -   `配置持久 NFS 导出`
    -   `配置 NFS 客户端，以持久挂载 NFS 导出`
    -   `将对 NFS 导出的访问限制到特定的客户端和网络`
-   **管理 SMB**
    -   `配置 SMB 共享`
    -   `创建和管理 SMB 用户`
    -   `创建仅限 SMB 用户`
    -   `限制对 SMB 共享的访问`
    -   `挂载 SMB 共享`
    -   `执行多用户 SMB 挂载`
-   **使用 Ansible 配置标准服务**
    -   `创建和修改 playbook`
    -   `了解和使用清单文件`
    -   `在 playbook 中使用变量`
    -   `使用 RHEL 系统角色`

对于所有实际任务操作型的红帽考试，您的所有系统配置必须在重启后仍然有效（无需人工干预）。