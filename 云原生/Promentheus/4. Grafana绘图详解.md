[toc]

# 简介
在《grafana配置简介》中，我们使用grafana的模板导入功能，完成了node节点的基础监控。

在《PromQL查询语法详解》中，我们知道所有的监控数据都来自于对prometheus采集的数据的检索和分析。

本篇文档我们就来尝试通过基于prometheus的查询数据，自己来绘制grafana图表。

# 仪表盘配置

## 1. 添加仪表盘

通过如下图添加一个dashbaord

![image-20220529103444017](.图片存放/image-20220529103444017.png)

进入如下界面

![image-20220529103456639](.图片存放/image-20220529103456639.png)

我们点击Add Query，进入panel的编辑页面：

![image-20220529103509729](.图片存放/image-20220529103509729.png)

## 2. 仪表盘设置

### 2.1 查询语句配置

我这里以查询cpu使用率为例，设置如下：

![image-20220529103521659](.图片存放/image-20220529103521659.png)

此时即可看到cpu使用率图形，如果还想查看cpu使用率中user的使用率以及sys的使用率，可添加查询如下：

![image-20220529103540657](.图片存放/image-20220529103540657.png)

### 2.2 图形设置

点击如下图标，进入图形设置界面

![image-20220529103554566](.图片存放/image-20220529103554566.png)

图形设置主要分为三段：
* 图形设置
* Y轴设置
* 图例的说明设置

先来看第一部分图形设置如下：

![image-20220529103608739](.图片存放/image-20220529103608739.png)

接下是Y轴设置：
![image-20220529103623756](.图片存放/image-20220529103623756.png)

图形说明的设置：

![image-20220529103636294](.图片存放/image-20220529103636294.png)

### 2.3 图形设置

![image-20220529103649187](.图片存放/image-20220529103649187.png)

### 2.4 告警设置

grafana支持告警设置，可以通过如下图创建相关告警：

![image-20220529103705451](.图片存放/image-20220529103705451.png)

grafana的告警在我们这里不作为重点，就不做展开说明了。

到此，一个cpu使用率的panel就创建完成了：

![image-20220529103719622](.图片存放/image-20220529103719622.png)


## 3. 添加其他图形

### 3.1 添加状态图

在上面生成的dashboard中再添加一个图形：

![image-20220529103804770](.图片存放/image-20220529103804770.png)

再次添加Add Query

![image-20220529103816984](.图片存放/image-20220529103816984.png)

添加一个状态查询。而我们知道状态查询是一个瞬时的状态，不适合使用线形图来表示。

接着我们点击图形设置，选择一个状态图：

![image-20220529103829494](.图片存放/image-20220529103829494.png)

设置值映射

![image-20220529103842341](.图片存放/image-20220529103842341.png)


修改图名称

![image-20220529103856775](.图片存放/image-20220529103856775.png)


到此，我们可以看到dashboard如下：

![image-20220529103909975](.图片存放/image-20220529103909975.png)


这样看起来有点儿丑，我们可缩放图，以调整其大小。这里不再做详细说明

### 3.2 添加Gauge图

下面是一个展示根分区使用率的例子：

![image-20220529103921772](.图片存放/image-20220529103921772.png)

设置图形展示：
![image-20220529103934335](.图片存放/image-20220529103934335.png)

保存之后，我们整个dashboard就变为这个样子：

![image-20220529103951647](.图片存放/image-20220529103951647.png)

## 4. 基于变量设置图形模板


### 4.1 添加变量
在上面所有的图形设置当中，其实一直存在一个问题： 我们所有的数据都是基于192.168.0.107:9100这个instance而来，当我们有多个采集目标的时候，如果我希望查看指定目标的监控图怎么办？ 

按照我们上面的方法，我们只能为每个节点绘一套图，这当然是一个很low的办法。

事实上，grafana为我们提供了模板变量。我们只需要将我们需要替换的部分使用变量代替即可。如上面说到的，我可以使用一个$host的变量来接收instance的值，当值为192.168.0.107:9100时，即展示192.168.0.107这个节点的监控数据。当为其他值时，则展示其他节点的监控数据。

点击grafana的设置： 
![image-20220529104010295](.图片存放/image-20220529104010295.png)

![image-20220529104148935](.图片存放/image-20220529104148935.png)

点击Variables和Add variabel

![image-20221022145653278](./.图片存放/image-20221022145653278.png)

点击添加：

![image-20221022150006802](./.图片存放/image-20221022150006802.png)

点击save dashboard，保存一下dashboard。

### 4.2 使用变量

现在我们只需要修改我们dashboard中的查询语句如下：

![image-20221022150100816](./.图片存放/image-20221022150100816.png)

修改写死的部分为变量

![image-20221022150139587](./.图片存放/image-20221022150139587.png)

其他图形也如法炮制即可。

然后我们回到dashboard的界面，即可选择相应的主机： 


![image-20221022150232019](./.图片存放/image-20221022150232019.png)

# 附录

## 模板变量高级用法

关于模板变量，除了使用数据的label，还支持直接将数据指标作为变量，将一个查询的结果集作为变量传递等。

更多查询语法：


名称|	描述
---|---
label_values(label)	|返回label每个指标中的标签值列表。
label_values(metric, label)|	返回label指定度量标准中的标签值列表。
metrics(metric)|	返回与指定metric正则表达式匹配的度量标准列表。
query_result(query)|	返回一个Prometheus查询结果列表query。


## 参考

* [《Grafana全面瓦解》](https://www.jianshu.com/p/7e7e0d06709b)
* [《Grafana的一些使用技巧》](https://juejin.im/post/5a9f29e8f265da23783fccae)
